<!doctype html><html><head>
    <style>
        html {
            max-width: 1000px;
            margin: auto;
        }
    </style>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"><style id="wiz_code_style">.wiz-editor-body .wiz-code-container{position: relative; padding:8px 0; margin: 5px 0;text-indent:0; text-align:left;}.CodeMirror {font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace; color: black; font-size: 10.5pt; font-size: 0.875rem}.wiz-editor-body .wiz-code-container .CodeMirror div {margin-top: 0; margin-bottom: 0;}.CodeMirror-lines {padding: 4px 0;}.CodeMirror pre {padding: 0 4px;}.CodeMirror pre.CodeMirror-line {min-height: 24px;}.CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {background-color: white;}.CodeMirror-gutters {border-right: 1px solid #ddd; background-color: #f7f7f7; white-space: nowrap;}.CodeMirror-linenumbers {}.CodeMirror-linenumber {padding: 0 3px 0 5px; min-width: 20px; text-align: right; color: #999; white-space: nowrap;}.CodeMirror-guttermarker {color: black;}.CodeMirror-guttermarker-subtle {color: #999;}.CodeMirror-cursor {border-left: 1px solid black; border-right: none; width: 0;}.CodeMirror div.CodeMirror-secondarycursor {border-left: 1px solid silver;}.cm-fat-cursor .CodeMirror-cursor {width: auto; border: 0 !important; background: #7e7;}.cm-fat-cursor div.CodeMirror-cursors {z-index: 1;}.cm-fat-cursor-mark {background-color: rgba(20, 255, 20, 0.5);-webkit-animation: blink 1.06s steps(1) infinite;-moz-animation: blink 1.06s steps(1) infinite;animation: blink 1.06s steps(1) infinite;}.cm-animate-fat-cursor {width: auto; border: 0; -webkit-animation: blink 1.06s steps(1) infinite; -moz-animation: blink 1.06s steps(1) infinite; animation: blink 1.06s steps(1) infinite; background-color: #7e7;}@-moz-keyframes blink {  0% {}  50% { background-color: transparent; }  100% {}}@-webkit-keyframes blink {  0% {}  50% { background-color: transparent; }  100% {}}@keyframes blink {  0% {}  50% { background-color: transparent; }  100% {}}.CodeMirror-overwrite .CodeMirror-cursor {}.cm-tab { display: inline-block; text-decoration: inherit; }.CodeMirror-rulers {position: absolute; left: 0; right: 0; top: -50px; bottom: -20px; overflow: hidden;}.CodeMirror-ruler {border-left: 1px solid #ccc; top: 0; bottom: 0; position: absolute;}.cm-s-default .cm-header {color: blue;}.cm-s-default .cm-quote {color: #090;}.cm-negative {color: #d44;}.cm-positive {color: #292;}.cm-header, .cm-strong {font-weight: bold;}.cm-em {font-style: italic;}.cm-link {text-decoration: underline;}.cm-strikethrough {text-decoration: line-through;}.cm-s-default .cm-keyword {color: #708;}.cm-s-default .cm-atom {color: #219;}.cm-s-default .cm-number {color: #164;}.cm-s-default .cm-def {color: #00f;}.cm-s-default .cm-variable,.cm-s-default .cm-punctuation,.cm-s-default .cm-property,.cm-s-default .cm-operator {}.cm-s-default .cm-variable-2 {color: #05a;}.cm-s-default .cm-variable-3 {color: #085;}.cm-s-default .cm-comment {color: #a50;}.cm-s-default .cm-string {color: #a11;}.cm-s-default .cm-string-2 {color: #f50;}.cm-s-default .cm-meta {color: #555;}.cm-s-default .cm-qualifier {color: #555;}.cm-s-default .cm-builtin {color: #30a;}.cm-s-default .cm-bracket {color: #997;}.cm-s-default .cm-tag {color: #170;}.cm-s-default .cm-attribute {color: #00c;}.cm-s-default .cm-hr {color: #999;}.cm-s-default .cm-link {color: #00c;}.cm-s-default .cm-error {color: #f00;}.cm-invalidchar {color: #f00;}.CodeMirror-composing { border-bottom: 2px solid; }div.CodeMirror span.CodeMirror-matchingbracket {color: #0b0;}div.CodeMirror span.CodeMirror-nonmatchingbracket {color: #a22;}.CodeMirror-matchingtag { background: rgba(255, 150, 0, .3); }.CodeMirror-activeline-background {background: #e8f2ff;}.CodeMirror {position: relative; background: #f5f5f5;}.CodeMirror-scroll {overflow: hidden !important; margin-bottom: 0; margin-right: -30px; padding: 16px 30px 16px 0; outline: none; position: relative;}.CodeMirror-sizer {position: relative; border-right: 30px solid transparent;}.CodeMirror-vscrollbar, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {position: absolute; z-index: 6; display: none;}.CodeMirror-vscrollbar {right: 0; top: 0; overflow-x: hidden; overflow-y: scroll;}.CodeMirror-hscrollbar {bottom: 0; left: 0 !important; overflow-y: hidden; overflow-x: scroll;pointer-events: auto !important;outline: none;}.CodeMirror-scrollbar-filler {right: 0; bottom: 0;}.CodeMirror-gutter-filler {left: 0; bottom: 0;}.CodeMirror-gutters {position: absolute; left: 0; top: 0; min-height: 100%; z-index: 3;}.CodeMirror-gutter {white-space: normal; height: 100%; display: inline-block; vertical-align: top; margin-bottom: -30px;}.CodeMirror-gutter-wrapper {position: absolute; z-index: 4; background: none !important; border: none !important;}.CodeMirror-gutter-background {position: absolute; top: 0; bottom: 0; z-index: 4;}.CodeMirror-gutter-elt {position: absolute; cursor: default; z-index: 4;}.CodeMirror-gutter-wrapper ::selection { background-color: transparent }.CodeMirror-gutter-wrapper ::-moz-selection { background-color: transparent }.CodeMirror-lines {cursor: text; min-height: 1px;}.CodeMirror pre {-moz-border-radius: 0; -webkit-border-radius: 0; border-radius: 0; border-width: 0; background: transparent; font-family: inherit; font-size: inherit; margin: 0; white-space: pre; word-wrap: normal; line-height: inherit; color: inherit; z-index: 2; position: relative; overflow: visible; -webkit-tap-highlight-color: transparent; -webkit-font-variant-ligatures: contextual; font-variant-ligatures: contextual;}.CodeMirror-wrap pre {word-wrap: break-word; white-space: pre-wrap; word-break: normal;}.CodeMirror-linebackground {position: absolute; left: 0; right: 0; top: 0; bottom: 0; z-index: 0;}.CodeMirror-linewidget {position: relative; z-index: 2; padding: 0.1px;}.CodeMirror-widget {}.CodeMirror-rtl pre { direction: rtl; }.CodeMirror-code {outline: none;}.CodeMirror-scroll,.CodeMirror-sizer,.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber {-moz-box-sizing: content-box; box-sizing: content-box;}.CodeMirror-measure {position: absolute; width: 100%; height: 0; overflow: hidden; visibility: hidden;}.CodeMirror-cursor {position: absolute; pointer-events: none;}.CodeMirror-measure pre { position: static; }div.CodeMirror-cursors {visibility: hidden; position: relative; z-index: 3;}div.CodeMirror-dragcursors {visibility: visible;}.CodeMirror-focused div.CodeMirror-cursors {visibility: visible;}.CodeMirror-selected { background: #d9d9d9; }.CodeMirror-focused .CodeMirror-selected { background: #d7d4f0; }.CodeMirror-crosshair { cursor: crosshair; }.CodeMirror-line::selection, .CodeMirror-line > span::selection, .CodeMirror-line > span > span::selection { background: #d7d4f0; }.CodeMirror-line::-moz-selection, .CodeMirror-line > span::-moz-selection, .CodeMirror-line > span > span::-moz-selection { background: #d7d4f0; }.cm-searching {background: #ffa; background: rgba(255, 255, 0, .4);}.cm-force-border { padding-right: .1px; }@media print {  .CodeMirror div.CodeMirror-cursors {visibility: hidden;}}.cm-tab-wrap-hack:after { content: ""; }span.CodeMirror-selectedtext { background: none; }.CodeMirror-activeline-background, .CodeMirror-selected {transition: visibility 0ms 100ms;}.CodeMirror-blur .CodeMirror-activeline-background, .CodeMirror-blur .CodeMirror-selected {visibility:hidden;}.CodeMirror-blur .CodeMirror-matchingbracket {color:inherit !important;outline:none !important;text-decoration:none !important;}.CodeMirror-sizer {min-height:auto !important;}</style><style id="wiz_custom_css">html, .wiz-editor-body {font-size: 12pt;}.wiz-editor-body {font-family: Helvetica, "Hiragino Sans GB", "微软雅黑", "Microsoft YaHei UI", SimSun, SimHei, arial, sans-serif;line-height: 1.7;margin: 0 auto;padding: 20px 16px;padding: 1.25rem 1rem;}.wiz-editor-body h1,.wiz-editor-body h2,.wiz-editor-body h3,.wiz-editor-body h4,.wiz-editor-body h5,.wiz-editor-body h6 {margin:20px 0 10px;margin:1.25rem 0 0.625rem;padding: 0;font-weight: bold;}.wiz-editor-body h1 {font-size:20pt;font-size:1.67rem;}.wiz-editor-body h2 {font-size:18pt;font-size:1.5rem;}.wiz-editor-body h3 {font-size:15pt;font-size:1.25rem;}.wiz-editor-body h4 {font-size:14pt;font-size:1.17rem;}.wiz-editor-body h5 {font-size:12pt;font-size:1rem;}.wiz-editor-body h6 {font-size:12pt;font-size:1rem;color: #777777;margin: 1rem 0;}.wiz-editor-body div,.wiz-editor-body p,.wiz-editor-body ul,.wiz-editor-body ol,.wiz-editor-body dl,.wiz-editor-body li {margin:8px 0;}.wiz-editor-body blockquote,.wiz-editor-body table,.wiz-editor-body pre,.wiz-editor-body code {margin:8px 0;}.wiz-editor-body .CodeMirror pre {margin:0;}.wiz-editor-body a {word-wrap: break-word;text-decoration-skip-ink: none;}.wiz-editor-body ul,.wiz-editor-body ol {padding-left:32px;padding-left:2rem;}.wiz-editor-body ol.wiz-list-level1 > li {list-style-type:decimal;}.wiz-editor-body ol.wiz-list-level2 > li {list-style-type:lower-latin;}.wiz-editor-body ol.wiz-list-level3 > li {list-style-type:lower-roman;}.wiz-editor-body li.wiz-list-align-style {list-style-position: inside; margin-left: -1em;}.wiz-editor-body blockquote {padding: 0 12px;}.wiz-editor-body blockquote > :first-child {margin-top:0;}.wiz-editor-body blockquote > :last-child {margin-bottom:0;}.wiz-editor-body img {border:0;max-width:100%;height:auto !important;margin:2px 0;}.wiz-editor-body table {border-collapse:collapse;border:1px solid #bbbbbb;}.wiz-editor-body td,.wiz-editor-body th {padding:4px 8px;border-collapse:collapse;border:1px solid #bbbbbb;min-height:28px;word-break:break-word;box-sizing: border-box;}.wiz-editor-body td > div:first-child {margin-top:0;}.wiz-editor-body td > div:last-child {margin-bottom:0;}.wiz-editor-body img.wiz-svg-image {box-shadow:1px 1px 4px #E8E8E8;}.wiz-hide {display:none !important;}</style></head><body spellcheck="false" class="wiz-editor-body" style><div>尝试翻译 Inside The Python Virtual Machine<br></div><div>书籍地址：<a href="https://leanpub.com/insidethepythonvirtualmachine/read">https://leanpub.com/insidethepythonvirtualmachine/read</a><br></div><div>原书作者：<span data-slate-fragment="JTdCJTIyb2JqZWN0JTIyJTNBJTIyZG9jdW1lbnQlMjIlMkMlMjJkYXRhJTIyJTNBJTdCJTdEJTJDJTIybm9kZXMlMjIlM0ElNUIlN0IlMjJvYmplY3QlMjIlM0ElMjJibG9jayUyMiUyQyUyMnR5cGUlMjIlM0ElMjJwYXJhZ3JhcGglMjIlMkMlMjJpc1ZvaWQlMjIlM0FmYWxzZSUyQyUyMmRhdGElMjIlM0ElN0IlN0QlMkMlMjJub2RlcyUyMiUzQSU1QiU3QiUyMm9iamVjdCUyMiUzQSUyMmlubGluZSUyMiUyQyUyMnR5cGUlMjIlM0ElMjJsaW5rJTIyJTJDJTIyaXNWb2lkJTIyJTNBZmFsc2UlMkMlMjJkYXRhJTIyJTNBJTdCJTIyaHJlZiUyMiUzQSUyMmh0dHBzJTNBJTJGJTJGdHdpdHRlci5jb20lMkZvYmlfaW5jJTIyJTdEJTJDJTIybm9kZXMlMjIlM0ElNUIlN0IlMjJvYmplY3QlMjIlM0ElMjJ0ZXh0JTIyJTJDJTIybGVhdmVzJTIyJTNBJTVCJTdCJTIyb2JqZWN0JTIyJTNBJTIybGVhZiUyMiUyQyUyMnRleHQlMjIlM0ElMjIlNDBvYmlfaW5jJTIyJTJDJTIybWFya3MlMjIlM0ElNUIlNUQlN0QlNUQlN0QlNUQlN0QlNUQlN0QlNUQlN0Q="><a href="https://twitter.com/obi_inc">@obi_inc</a>，翻译：<a href="https://github.com/nanguage">@NaNg</a></span></div><div><span>学习目的，水平有限，有错误请指正。</span>本文以 <a href="https://github.com/python/cpython/tree/3.5">CPython3.5 源码</a>为标准。</div><div><br></div><h2>1. Python程序的执行过程</h2><div>根据解释器调用方式的不同，一个Python程序的执行可以分为二或三个阶段：</div><div>1. 初始化（Initialization）：这个阶段涉及到对于python进程所需要的一系列数据结构的初始化。此阶段在交互模式下不会进行。</div><div>2. 编译（Compiling）：该阶段涉及到将源代码解析成语法树，创建 AST(Abstract Syntax Tree，抽象语法树)对象，创建 symbol tables以及生成 code objects。</div><div>3. 解释运行（Interpreting）：这个阶段涉及到在一些环境（context）下对 code object 的执行。</div><div><img width="1014" height="582" src="Inside The Python Virtual Machine（前三章翻译）_files/f05cc14b-3dfb-4106-b8d2-c3d7045390ee.png"><br></div><blockquote><div style="text-align: left;"><span data-wiz-span="data-wiz-span" style="color: rgb(53, 60, 71);">图1. python 代码执行过程示意图</span></div></blockquote><h3 style="font-size: 1.25rem;"><hr></h3><h3 style="font-size: 1.25rem;">1.a 补充知识：CPython 的项目结构：</h3><div>参考 CPython 开发指南（<a href="https://cpython-devguide.readthedocs.io/setup/#directory-structure" style="text-decoration-skip-ink:none;">Python Developer's Guide</a>），（<a href="https://github.com/python/cpython" style="text-decoration-skip-ink:none;">CPython source code</a>）。CPython项目中的大多数C代码位于少数几个文件夹中：</div><div><ul><li>Include：一些头文件。</li><li>Objects：<span>包括从 int 到 type的一系列</span>对象（object）的实现。</li><li>Python：解释器、字节码编译器以及一些其它的基础设施。</li><li>Parser：parser，lexer 以及 parser generator。</li><li>Modules：stdlib 扩展模块，以及 main.c。</li><li>Programs：内容不多，主要是作为程序入口的 main 函数。</li></ul></div><div><hr></div><div><span style="font-size: 1.25rem; font-weight: bold;">1.1 初始化</span><br></div><div>当以非交互模式运行一个Python 程序的时候，比如 :</div><div data-mode="Shell" data-theme="default" id="wiz_cm_1566790772536_4465" class="wiz-code-container"><textarea style="display:none;">$ python test.py</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566790772536_4465"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 32px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-def">$ python</span> test.py</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 32px;"></div><div class="CodeMirror-gutters" style="height: 62px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;"><span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">C</span> runtime 会首先进行一些初始化，比如包载入、环境变量的设置与检查，然后会执行python的<span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">main</span>函数（<a href="https://github.com/python/cpython/blob/3.5/Programs/python.c">Programs/python.c</a>）。接着 main 函数会进一步调用 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">Py_Main</span> 函数（<a href="https://github.com/python/cpython/blob/3.5/Modules/main.c">Modules/main.c</a>）进行包括解析命令行参数设置flags、读取环境变量（详见<a href="https://docs.python.org/3.6/using/cmdline.html">此处</a>）、running hooks、哈希随机化等在内的一些解释器初始化操作。在此过程中 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">Py_Initialize</span> 函数（<a href="https://github.com/python/cpython/blob/3.5/Python/pylifecycle.c">Python/pylifecycle.c</a>）会被调用，它会初始化两个非常重要的数据结构：interpreter state 和 thread state。</div><div>可以看一下 interpreter state data structure 的在源码中的定义（<a href="https://github.com/python/cpython/blob/3.5/Include/pystate.h#L19">Include/pystate.h</a>）：</div><div data-mode="C" data-theme="default" id="wiz_cm_1566797638784_8473" class="wiz-code-container"><textarea style="display:none;">typedef struct _is {

    struct _is *next;
    struct _ts *tstate_head;

    PyObject *modules;
    PyObject *modules_by_index;
    PyObject *sysdict;
    PyObject *builtins;
    PyObject *importlib;

    PyObject *codec_search_path;
    PyObject *codec_search_cache;
    PyObject *codec_error_registry;
    int codecs_initialized;
    int fscodec_initialized;

    PyObject *builtins_copy;
} PyInterpreterState;</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566797638784_8473"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 464px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>19</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>19</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-def">_is</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">_is</span> <span class="cm-operator">*</span><span class="cm-variable">next</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">_ts</span> <span class="cm-operator">*</span><span class="cm-variable">tstate_head</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">modules</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">modules_by_index</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">sysdict</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">builtins</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">importlib</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">codec_search_path</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">codec_search_cache</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">codec_error_registry</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">codecs_initialized</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">fscodec_initialized</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">builtins_copy</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">} <span class="cm-variable">PyInterpreterState</span>;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 464px;"></div><div class="CodeMirror-gutters" style="height: 494px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div><ol class="wiz-list-level1"><li style="text-align: left;"><span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">*next </span>字段为一个指向另一个解释器实例的引用（多个解释器可以同时存在于一个进程当中，译注：这个特性有望用于解决 CPython 的 GIL 问题，参考 <a href="https://www.python.org/dev/peps/pep-0554/">PEP554</a>）</li><li style="text-align: left;"><span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">*tstate_head </span>字段指向 main thread of execution。</li><li style="text-align: left;"><span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">modules</span>, <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">modules_by_index</span>, <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">sysdict</span>, <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">builtins</span> 以及 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">importlib</span> 从它们的名字就能理解。它们都被定义为 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">PyObject</span> 的实例，在 Python 虚拟机中 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">PyObject</span> 为最基本的对象类型。</li><li style="text-align: left;"><span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">codec*</span> 相关的字段持有用于定位、加载编码方式（encodings）的信息，对于字节解码（decoding bytes）非常重要。</li></ol></div><div><br></div><div>程序的运行必须在一个线程之中进行，thread state structure 包含了一个线程执行 python code object 所需的信息，关于 thread state 定义的其中一部分代码如下（<a href="https://github.com/python/cpython/blob/3.5/Include/pystate.h#L69">Include/pystate.h</a>）：</div><div data-mode="C" data-theme="default" id="wiz_cm_1566799335589_9795" class="wiz-code-container"><textarea style="display:none;">typedef struct _ts {
    struct _ts *prev; 
    struct _ts *next; 
    PyInterpreterState *interp;

    struct _frame *frame;
    int recursion_depth;
    char overflowed;

    char recursion_critical;
    int tracing;
    int use_tracing;

    Py_tracefunc c_profilefunc;
    Py_tracefunc c_tracefunc;
    PyObject *c_profileobj;
    PyObject *c_traceobj;

    PyObject *curexc_type;
    PyObject *curexc_value;
    PyObject *curexc_traceback;

    PyObject *exc_type;
    PyObject *exc_value;
    PyObject *exc_traceback;

    PyObject *dict;  /* Stores per-thread state */
    int gilstate_counter;

    ... 
} PyThreadState;
</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566799335589_9795"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 776px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>32</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>32</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-def">_ts</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">_ts</span> <span class="cm-operator">*</span><span class="cm-variable">prev</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">_ts</span> <span class="cm-operator">*</span><span class="cm-variable">next</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyInterpreterState</span> <span class="cm-operator">*</span><span class="cm-variable">interp</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">_frame</span> <span class="cm-operator">*</span><span class="cm-variable">frame</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">recursion_depth</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">char</span> <span class="cm-variable">overflowed</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">char</span> <span class="cm-variable">recursion_critical</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">tracing</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-type">use_tracing</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">Py_tracefunc</span> <span class="cm-variable">c_profilefunc</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">Py_tracefunc</span> <span class="cm-type">c_tracefunc</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">c_profileobj</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-type">c_traceobj</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-type">curexc_type</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">20</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">curexc_value</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">21</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-type">curexc_traceback</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">22</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">23</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-type">exc_type</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">24</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">exc_value</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">25</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-type">exc_traceback</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">26</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">27</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">dict</span>; &nbsp;<span class="cm-comment">/* Stores per-thread state */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">28</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">gilstate_counter</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">29</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">30</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  ... </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">31</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">} <span class="cm-variable">PyThreadState</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">32</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 776px;"></div><div class="CodeMirror-gutters" style="height: 806px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">初始化过程还会设置一些重要的机制，比如基本的 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">stdio</span>。</div><h3><span>1.2 <span>简单描述：</span>从编译到代码运行</span></h3><h3></h3><div style="text-align: left;">一旦完成了所有的初始化，<span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">Py_Main</span> 函数会调用 <a href="https://github.com/python/cpython/blob/3.5/Modules/main.c#L305"><span data-wiz-span="data-wiz-span" style="font-size:1.013rem;font-family:&quot;Lucida Console&quot;, monospace;background-color:rgb(239, 239, 239)">run_file</span></a> 函数，随后以下的将发生调用：</div><div><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">PyRun_AnyFileExFlags -&gt; PyRun_SimpleFileExFlags-&gt;PyRun_FileExFlags-&gt;PyParser_ASTFromFileObject</span><br></div><div>在&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/762f93ff2efd6b7ef0177cad57939c0ab2002eac/Python/pythonrun.c#L372">PyRun_SimpleFileExFlags</a></span>&nbsp;函数调用中，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">__main__</span>&nbsp;namespace 将被创建，文件内容将在其中被运行。它也将检查<span>文件的 pyc 版本是否存在（</span>pyc 文件即一个储存了已经被执行过的py文件编译后的代码（字节码）的文件）。当文件的 pyc 版本存在的时候，将会尝试以二进制形式读取并执行它。而当 pyc 文件不存在的时候，会顺着&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/762f93ff2efd6b7ef0177cad57939c0ab2002eac/Python/pythonrun.c#L1032">PyRun_FileExFlags</a></span>&nbsp;向下调用，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/762f93ff2efd6b7ef0177cad57939c0ab2002eac/Python/pythonrun.c#L1369">PyParser_ASTFromFileObject</a></span>&nbsp;函数会接着调用&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/b82e17e626f7b1cd98aada0b1ebb65cb9f8fb184/Parser/parsetok.c#L163">PyParser_ParseFileObject</a></span>&nbsp;函数，它会读取被执行模块的内容并建立 parse tree，然后将 parse tree 传递给&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/51aac15f6d525595e200e3580409c4b8656e8a96/Python/ast.c#L772">PyAST_FromNodeObject</a></span>&nbsp;根据 parse tree 创建 AST。</div><div style="text-align: left;">AST 生成后会被传给 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/762f93ff2efd6b7ef0177cad57939c0ab2002eac/Python/pythonrun.c#L1125">run_mod</a></span> 函数，这个函数会接着调用&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/ce6a070414ed1e1374d1e6212bfbff61b6d5d755/Python/compile.c#L312">PyAST_CompileObject</a></span>&nbsp;根据 AST 生成 code object。并且在调用&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">PyAST_CompileObject</span>&nbsp;生成字节码的时候会经过一个简单的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">peephole</span>&nbsp;optimizer 进行字节码优化。随后 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">run_mod</span> 会调用&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/51aac15f6d/Python/ceval.c#L712">PyEval_EvalCode</a></span>&nbsp;随之产生一系列的 function call:</div><div style="text-align: left;"><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">PyEval_EvalCode-&gt;PyEval_EvalCodeEx-&gt;_PyEval_EvalCodeWithName-&gt;PyEval_EvalFrameEx</span><br></div><div>在&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">PyEval_EvalFrameEx</span>&nbsp;中的解释器循环（interpreter loop）才会<span>实际</span>进行对 code object 的运行处理。它不只是将 code object 作为参数而是使用一个 frame object，它有一个字段用来保存到 code object 的引用。简单来说，解释器循环会不断读取储存在一个指令数组中的下一个指令进行执行，增加或者删除位于栈上的对象，直到没有新的指令或者中途发生异常中断了循环。</div><div>Python 提供了一系列可以用于探索 code object 的<span>函数</span>。比如说，一个简单的程序可以被编译为一个 code object 和反编译（disassembled）成被python虚拟机执行的 opcodes：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566811505181_2900" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; import dis
&gt;&gt;&gt; def square(x):
...     return x*x
... 
&gt;&gt;&gt; dis.dis(square)
  2           0 LOAD_FAST                0 (x)
              2 LOAD_FAST                0 (x)
              4 BINARY_MULTIPLY
              6 RETURN_VALUE</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566811505181_2900"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 224px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">import</span> <span class="cm-variable">dis</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">def</span> <span class="cm-def">square</span>(<span class="cm-variable">x</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">return</span> <span class="cm-variable">x</span><span class="cm-operator">*</span><span class="cm-variable">x</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">dis</span>.<span class="cm-property">dis</span>(<span class="cm-variable">square</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-number">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">0</span> <span class="cm-variable">LOAD_FAST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> (<span class="cm-variable">x</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">2</span> <span class="cm-variable">LOAD_FAST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> (<span class="cm-variable">x</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">4</span> <span class="cm-variable">BINARY_MULTIPLY</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">6</span> <span class="cm-variable">RETURN_VALUE</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="height: 254px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">&nbsp;头文件 <a href="https://github.com/python/cpython/blob/3.5/Include/opcode.h">Include/opcode.h</a> 中包含了 python 虚拟机支持的 instruction/opcodes 清单。其实 opcodes 的概念很容易理解，在上面的例子中有4条 instruction：<span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">LOAD_FAST</span> 将它的参数对应的值（这里对应x）加载到栈上。python 虚拟机是基于栈的 （stack based），也就是说 opcode 进行求值的对象以及求值得到的结果都会保存在栈上。<span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">BINARY_MULTIPLY</span>&nbsp;opcode 会将前两条指令的结果从栈中弹出（pop），执行二进制乘法运算然后将结果放（push）回栈顶。RETURN_VALUE 指令会从栈中弹出设置为返回值并中断解释器循环。</div><div style="text-align: left;">这里还涉及到几个暂时没有被解答的问题：</div><div style="text-align: left;"><ol class="wiz-list-level1"><li><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">LOAD_FAST</span>&nbsp;加载的值来自于哪里？</li><li>指令中使用的参数来自于哪里？</li><li>嵌套的函数与方法调用是如何被管理的？</li><li>解释器循环是如何进行异常处理的？</li></ol></div><div>当所有的指令都被执行以后，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">Py_Main</span>&nbsp;将继续执行一些清理（clean up）过程。就像&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">Py_Initialize</span>&nbsp;所做的那样，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/pylifecycle.c#L519">Py_Finalize</a></span>&nbsp;会被调用完成一些清理任务，比如等待线程退出、调用 exit hooks、清理解释器分配的仍然被使用的内存等等。</div><h3>1.3 编译 Python 源代码</h3><div>尽管一般并不认为 Python 是一门编译性的语言，但实际上在代码执行前 Python 源码仍会被编译成可以被 python 虚拟机执行的字节码。python 的编译过程非常直接，并不涉及到很多复杂的步骤。一个完整的 python 程序编译过程有以下几个步骤：</div><div><ol class="wiz-list-level1"><li>将源代码 parsing 成一个 parse tree。</li><li>将 parse tree 转化为 AST（抽象语法树， abstract syntax tree）。</li><li>生成符号表（symbol table）。</li><li>从 AST 生成 code object，这一步包含：</li><ol class="wiz-list-level2"><li>将 AST 转化为一个 flow control graph。</li><li>从 control flow graph 产生 code object。&nbsp;</li></ol></ol></div><div>其中将从源码到 AST 是一个标准的过程，python 这里并没有什么特别的，所以本书会把关注点更多放在 symbol tables 以及 code objects 的生成过程上。如果你对于 Parsing 的详细原理比较感兴趣，推荐阅读经典的<a href="https://www.amazon.co.uk/Compilers-Principles-Techniques-Alfred-Aho/dp/0201100886">《龙书》（dragon book）</a>。<br class="Apple-interchange-newline"></div><h4>1.3.1 从源码到 parse tree</h4><div>按照 Dragon book 中的描述 python 的 parser 属于一种 <a href="https://en.wikipedia.org/wiki/LL_parser">LL(1)</a> parser。CPython 目录下的 <a href="https://github.com/python/cpython/blob/3.5/Grammar/Grammar">Grammar/Grammer</a>&nbsp;文件中包含了 Python 语言文法的 <a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form">EBNF</a>（Extended Backus–Naur Form，扩展巴科斯范式）：</div><div data-mode="Shell" data-theme="default" id="wiz_cm_1566816421565_8617" class="wiz-code-container"><textarea style="display:none;">...
stmt: simple_stmt | compound_stmt
simple_stmt: small_stmt (';' small_stmt)* [';'] NEWLINE
small_stmt: (expr_stmt | del_stmt | pass_stmt | flow_stmt |
             import_stmt | global_stmt | nonlocal_stmt | assert_stmt)
expr_stmt: testlist_star_expr (augassign (yield_expr|testlist) |
                     ('=' (yield_expr|testlist_star_expr))*)
testlist_star_expr: (test|star_expr) (',' (test|star_expr))* [',']
augassign: ('+=' | '-=' | '*=' | '@=' | '/=' | '%=' | '&amp;=' | '|=' | '^=' |
            '&lt;&lt;=' | '&gt;&gt;=' | '**=' | '//=')
del_stmt: 'del' exprlist
pass_stmt: 'pass'
flow_stmt: break_stmt | continue_stmt | return_stmt | raise_stmt | yield_stmt
break_stmt: 'break'
continue_stmt: 'continue'
return_stmt: 'return' [testlist]
yield_stmt: yield_expr
raise_stmt: 'raise' [test ['from' test]]
import_stmt: import_name | import_from
import_name: 'import' dotted_as_names
import_from: ('from' (('.' | '...')* dotted_name | ('.' | '...')+)
              'import' ('*' | '(' import_as_names ')' | import_as_names))
import_as_name: NAME ['as' NAME]
...</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566816421565_8617"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 584px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>24</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>24</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">...</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">stmt: simple_stmt | compound_stmt</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">simple_stmt: small_stmt (<span class="cm-string">';'</span> small_stmt)* [<span class="cm-string">';'</span>] NEWLINE</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">small_stmt: (expr_stmt | del_stmt | pass_stmt | flow_stmt |</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; import_stmt | global_stmt | nonlocal_stmt | assert_stmt)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">expr_stmt: testlist_star_expr (augassign (yield_expr|testlist) |</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="cm-string">'='</span> (yield_expr|testlist_star_expr))*)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">testlist_star_expr: (test|star_expr) (<span class="cm-string">','</span> (test|star_expr))* [<span class="cm-string">','</span>]</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">augassign: (<span class="cm-string">'+='</span> | <span class="cm-string">'-='</span> | <span class="cm-string">'*='</span> | <span class="cm-string">'@='</span> | <span class="cm-string">'/='</span> | <span class="cm-string">'%='</span> | <span class="cm-string">'&amp;='</span> | <span class="cm-string">'|='</span> | <span class="cm-string">'^='</span> |</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'&lt;&lt;='</span> | <span class="cm-string">'&gt;&gt;='</span> | <span class="cm-string">'**='</span> | <span class="cm-string">'//='</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">del_stmt: <span class="cm-string">'del'</span> exprlist</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">pass_stmt: <span class="cm-string">'pass'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">flow_stmt: break_stmt | continue_stmt | return_stmt | raise_stmt | yield_stmt</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">break_stmt: <span class="cm-string">'break'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">continue_stmt: <span class="cm-string">'continue'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">return_stmt: <span class="cm-string">'return'</span> [testlist]</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">yield_stmt: yield_expr</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">raise_stmt: <span class="cm-string">'raise'</span> [test [<span class="cm-string">'from'</span> test]]</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">import_stmt: import_name | import_from</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">20</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">import_name: <span class="cm-string">'import'</span> dotted_as_names</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">21</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">import_from: (<span class="cm-string">'from'</span> ((<span class="cm-string">'.'</span> | <span class="cm-string">'...'</span>)* dotted_name | (<span class="cm-string">'.'</span> | <span class="cm-string">'...'</span>)<span class="cm-operator">+</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">22</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'import'</span> (<span class="cm-string">'*'</span> | <span class="cm-string">'('</span> import_as_names <span class="cm-string">')'</span> | import_as_names))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">23</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">import_as_name: NAME [<span class="cm-string">'as'</span> NAME]</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">24</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">...</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 584px;"></div><div class="CodeMirror-gutters" style="height: 614px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div>每次从命令行中运行一个 python 模块的时候，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/b82e17e626f7b1cd98aada0b1ebb65cb9f8fb184/Parser/parsetok.c#L163">PyParser_ParseFileObject</a></span>&nbsp;函数会启动对这个模块的 parsing过程，它会调用 tokenization 函数&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/69f37bcb28d7cd78255828029f895958b5baf6ff/Parser/tokenizer.c#L771">PyTokenizer_FromFile</a></span>&nbsp;，它接受模块的文件名作为参数，将模块文件的内容分解为一个个合法的 python tokens 或者发现语法错误时进行报错。</div><h4>1.3.2 Python tokens</h4><div style="text-align: left;">Python 源码可以看作是一系列的 tokens，比如说 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">return</span> 就是一个 keyword token，字面量 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">-2</span> 是一个数值字面量 token 等等。Parsing python 源码的第一步就是将源码分割为一个个的 token。Python 中存在以下几种 token：</div><div style="text-align: left;"><ol class="wiz-list-level1"><li>identifiers：由程序员定义的“名字”，包括函数名、变量名、类名等等。它们必须符合 python 文档中指定的<a href="https://docs.python.org/3.5/reference/lexical_analysis.html#identifiers">规范</a>。</li><li>operators：一些特殊的符号比如&nbsp;<code style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background: rgb(239, 239, 239);">+</code><span style="font-family: &quot;Noto Serif&quot;, serif; font-size: 1.125rem;">,<span>&nbsp;</span></span><code style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background: rgb(239, 239, 239);">*</code>&nbsp;能够对值进行运算产生结果。</li><li>delimiters：这类符号用来给表达式分组、提供标点、赋值操作，包括&nbsp;<code style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background: rgb(239, 239, 239);">(, )</code><span style="font-family: &quot;Noto Serif&quot;, serif; font-size: 1.125rem;">,<span>&nbsp;</span></span><code style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background: rgb(239, 239, 239);">{,}</code><span style="font-family: &quot;Noto Serif&quot;, serif; font-size: 1.125rem;">,<span>&nbsp;</span></span><code style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background: rgb(239, 239, 239);">=</code><span style="font-family: &quot;Noto Serif&quot;, serif; font-size: 1.125rem;">,<span>&nbsp;</span></span><code style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background: rgb(239, 239, 239);">*=</code>&nbsp;等。</li><li>literals：字面量，这类符号用于提供一些类型的常量。比如字符串、bytes 类型的字面量：<code style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background: rgb(239, 239, 239);">"Fred"</code><span style="font-family: &quot;Noto Serif&quot;, serif; font-size: 1.125rem;">,<span>&nbsp;</span></span><code style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background: rgb(239, 239, 239);">b"Fred"</code>&nbsp;、数值类型的<span>字面量</span>&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">2</span>&nbsp;、浮点类型字面量&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">1e100</span>&nbsp;、虚数字面量&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">10j</span>&nbsp;。</li><li style="text-align: left;">comments：以 <span data-wiz-span="data-wiz-span" style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">#</span> 开头的字符串字面量，用户代码注释。comments 总是位于一个 physical line 的结尾。（译注：关于什么是 physical line 与 logical line 可以参考<a href="https://stackoverflow.com/questions/31572589/difference-between-logical-line-and-physical-line-in-python">这里</a>）</li><li style="text-align: left;">NEWLINE：用于指示一行（logical line）的结束。</li><li style="text-align: left;">INDENT 与 DEDENT：表示一组复合语句（compound statements）的缩进层级（identation levels）。</li></ol></div><div style="text-align:left">一组 tokens 通过一个 NEWLINE token 被分割，组成一个 logical line，因而我们可以说一个 python 程序由一系列被 NEWLINE token 分割的 logical line 所组成。这些 logical line 可以映射到 python 语句（statements）。每一个 logical line 又由一系列 physical lines 所组成，physical line 的结尾是一个换行符（end-of-line）。多个 physical line 可以被连接在一起，连接可能是隐式的，比如在括号中的时候（包括 <span data-wiz-span="data-wiz-span" style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">()</span>, <span data-wiz-span="data-wiz-span" style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">[]</span>, <span data-wiz-span="data-wiz-span" style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">{}</span> 三种），也可能是显式的，也就是在行尾使用一个反斜杠 <span data-wiz-span="data-wiz-span" style="font-size: 0.9rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">\</span>。（译注：原文中说的是 logical line 可以被连接，我认为这里是错误的，想说的应该是 phycial lines 被连接为 logical line）。复合语句可以跨过多个 physical line，就像图1.3.2 中所展示的那样。缩进对于 python 语句的分组非常重要，python grammar 中有一条规则用于对它进行描述：<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">suite: simple_stmt | NEWLINE INDENT stmt+ DEDENT</span>&nbsp;，因而 python tokenizer 的一项主要任务就是生成 INDENT 和 DEDENT 到 parse tree。Tokenizer 使用一个栈来保持对缩进的跟踪，INDENT 与 DEDENT token 生成算法的伪代码如下：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566829464371_7142" class="wiz-code-container"><textarea style="display:none;">使用 0 初始化 indent 栈
for 每一个 logical line:
    if (当前行的缩进级别 &gt; 栈顶的级别):
        push(当前缩进级别)
        生成一个 INDENT token
    if (当前行的缩进级别 &lt; 栈顶的级别):
        if (栈中不存在一个缩进级别 == 当前缩进级别):
            报告一个错误
        for 栈顶的每一个 != 当前行缩进级的值:
        	移除这个值
            生成一个 DEDENT token
    tokenize(当前行)
对每一个栈上的值（除了0）生成 DEDENT token</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566829464371_7142"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 320px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">使用</span> <span class="cm-number">0</span> <span class="cm-variable">初始化</span> <span class="cm-variable">indent</span> <span class="cm-variable">栈</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">每一个</span> <span class="cm-variable">logical</span> <span class="cm-variable">line</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">当前行的缩进级别</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">栈顶的级别</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">push</span>(<span class="cm-variable">当前缩进级别</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">生成一个</span> <span class="cm-variable">INDENT</span> <span class="cm-variable">token</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">当前行的缩进级别</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">栈顶的级别</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">栈中不存在一个缩进级别</span> <span class="cm-operator">==</span> <span class="cm-variable">当前缩进级别</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">报告一个错误</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">栈顶的每一个</span> <span class="cm-operator">!=</span> <span class="cm-variable">当前行缩进级的值</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-tab">    </span><span class="cm-variable">移除这个值</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">生成一个</span> <span class="cm-variable">DEDENT</span> <span class="cm-variable">token</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tokenize</span>(<span class="cm-variable">当前行</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">对每一个栈上的值（除了0）生成</span> <span class="cm-variable">DEDENT</span> <span class="cm-variable">token</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 320px;"></div><div class="CodeMirror-gutters" style="height: 350px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">CPython 的实现中&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Parser/tokenizer.c#L858">PyTokenizer_FromFile</a></span>&nbsp;函数会按照从左到右，从上到下的对 python 源码文件进行扫描并进行 tokenize。空格字符除了终止符被用来分隔开 token，但这不是必须的。如果其中存在歧义，则按照从右到左合法的可能的最长字符串来理解。<span>比如说<span>&nbsp;</span></span><span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">2+2</span><span>&nbsp;，</span>是一个字面量 <span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">2</span>，一个 operator&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">+</span>，另一个字面量 <span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">2</span>。</div><div style="text-align: left;"><hr></div><h4>1.3.a 补充知识：调用 python tokenize</h4><div>在 python 中提供了 tokenize 的接口（标准模块函数 <a href="https://docs.python.org/3/library/tokenize.html#tokenize.tokenize">tokenize.tokenize</a>）可以使用它对 python 源代码进行 tokenize，它接受一个 ByteIO.readline 的 callable 对象返回一个 tokens 的 generator，对这个 generator 进行迭代就能得到被解析模块的 tokens 序列，比如：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566882163848_5509" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; from tokenize import tokenize
&gt;&gt;&gt; f = open("./test.py", 'rb')  # test.py 的内容只有一行 print("hello")
&gt;&gt;&gt; for t in tokenize(f.readline):
...     print(t)
... 
TokenInfo(type=59 (ENCODING), string='utf-8', start=(0, 0), end=(0, 0), line='')
TokenInfo(type=1 (NAME), string='print', start=(1, 0), end=(1, 5), line='print("hello")')
TokenInfo(type=53 (OP), string='(', start=(1, 5), end=(1, 6), line='print("hello")')
TokenInfo(type=3 (STRING), string='"hello"', start=(1, 6), end=(1, 13), line='print("hello")')
TokenInfo(type=53 (OP), string=')', start=(1, 13), end=(1, 14), line='print("hello")')
TokenInfo(type=0 (ENDMARKER), string='', start=(2, 0), end=(2, 0), line='')</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566882163848_5509"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 360px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>11</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>11</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">from</span> <span class="cm-variable">tokenize</span> <span class="cm-keyword">import</span> <span class="cm-variable">tokenize</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">f</span> <span class="cm-operator">=</span> <span class="cm-builtin">open</span>(<span class="cm-string">"./test.py"</span>, <span class="cm-string">'rb'</span>) &nbsp;<span class="cm-comment"># test.py 的内容只有一行 print("hello")</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">for</span> <span class="cm-variable">t</span> <span class="cm-keyword">in</span> <span class="cm-variable">tokenize</span>(<span class="cm-variable">f</span>.<span class="cm-property">readline</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">print</span>(<span class="cm-variable">t</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-property">TokenInfo</span>(<span class="cm-builtin">type</span><span class="cm-operator">=</span><span class="cm-number">59</span> (<span class="cm-variable">ENCODING</span>), <span class="cm-variable">string</span><span class="cm-operator">=</span><span class="cm-string">'utf-8'</span>, <span class="cm-variable">start</span><span class="cm-operator">=</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>), <span class="cm-variable">end</span><span class="cm-operator">=</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>), <span class="cm-variable">line</span><span class="cm-operator">=</span><span class="cm-string">''</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">TokenInfo</span>(<span class="cm-builtin">type</span><span class="cm-operator">=</span><span class="cm-number">1</span> (<span class="cm-variable">NAME</span>), <span class="cm-variable">string</span><span class="cm-operator">=</span><span class="cm-string">'print'</span>, <span class="cm-variable">start</span><span class="cm-operator">=</span>(<span class="cm-number">1</span>, <span class="cm-number">0</span>), <span class="cm-variable">end</span><span class="cm-operator">=</span>(<span class="cm-number">1</span>, <span class="cm-number">5</span>), <span class="cm-variable">line</span><span class="cm-operator">=</span><span class="cm-string">'print("hello")'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">TokenInfo</span>(<span class="cm-builtin">type</span><span class="cm-operator">=</span><span class="cm-number">53</span> (<span class="cm-variable">OP</span>), <span class="cm-variable">string</span><span class="cm-operator">=</span><span class="cm-string">'('</span>, <span class="cm-variable">start</span><span class="cm-operator">=</span>(<span class="cm-number">1</span>, <span class="cm-number">5</span>), <span class="cm-variable">end</span><span class="cm-operator">=</span>(<span class="cm-number">1</span>, <span class="cm-number">6</span>), <span class="cm-variable">line</span><span class="cm-operator">=</span><span class="cm-string">'print("hello")'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">TokenInfo</span>(<span class="cm-builtin">type</span><span class="cm-operator">=</span><span class="cm-number">3</span> (<span class="cm-variable">STRING</span>), <span class="cm-variable">string</span><span class="cm-operator">=</span><span class="cm-string">'"hello"'</span>, <span class="cm-variable">start</span><span class="cm-operator">=</span>(<span class="cm-number">1</span>, <span class="cm-number">6</span>), <span class="cm-variable">end</span><span class="cm-operator">=</span>(<span class="cm-number">1</span>, <span class="cm-number">13</span>), <span class="cm-variable">line</span><span class="cm-operator">=</span><span class="cm-string">'print("hello")'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">TokenInfo</span>(<span class="cm-builtin">type</span><span class="cm-operator">=</span><span class="cm-number">53</span> (<span class="cm-variable">OP</span>), <span class="cm-variable">string</span><span class="cm-operator">=</span><span class="cm-string">')'</span>, <span class="cm-variable">start</span><span class="cm-operator">=</span>(<span class="cm-number">1</span>, <span class="cm-number">13</span>), <span class="cm-variable">end</span><span class="cm-operator">=</span>(<span class="cm-number">1</span>, <span class="cm-number">14</span>), <span class="cm-variable">line</span><span class="cm-operator">=</span><span class="cm-string">'print("hello")'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">TokenInfo</span>(<span class="cm-builtin">type</span><span class="cm-operator">=</span><span class="cm-number">0</span> (<span class="cm-variable">ENDMARKER</span>), <span class="cm-variable">string</span><span class="cm-operator">=</span><span class="cm-string">''</span>, <span class="cm-variable">start</span><span class="cm-operator">=</span>(<span class="cm-number">2</span>, <span class="cm-number">0</span>), <span class="cm-variable">end</span><span class="cm-operator">=</span>(<span class="cm-number">2</span>, <span class="cm-number">0</span>), <span class="cm-variable">line</span><span class="cm-operator">=</span><span class="cm-string">''</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 360px;"></div><div class="CodeMirror-gutters" style="height: 390px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div>此外，还可以在命令行中调用 tokenize：</div><div data-mode="Shell" data-theme="default" id="wiz_cm_1566882604465_7047" class="wiz-code-container"><textarea style="display:none;">$ python -m tokenize test.py
0,0-0,0:            ENCODING       'utf-8'        
1,0-1,5:            NAME           'print'        
1,5-1,6:            OP             '('            
1,6-1,13:           STRING         '"hello"'      
1,13-1,14:          OP             ')'            
2,0-2,0:            ENDMARKER      ''             </textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566882604465_7047"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 176px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-def">$ python</span> <span class="cm-attribute">-m</span> tokenize test.py</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">0</span>,0-0,0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ENCODING &nbsp; &nbsp; &nbsp; <span class="cm-string">'utf-8'</span> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">1</span>,0-1,5: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'print'</span> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">1</span>,5-1,6: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  OP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'('</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">1</span>,6-1,13: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STRING &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'"hello"'</span> &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">1</span>,13-1,14: &nbsp; &nbsp; &nbsp; &nbsp;  OP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">')'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">2</span>,0-2,0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ENDMARKER &nbsp; &nbsp; &nbsp;<span class="cm-string">''</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="height: 206px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div><hr>tokenizer 生成的 tokens&nbsp; 随后会被传递给 parser 根据 python 的语法来生成 parse tree 。当 parser 发现一个 token 违反了语法规则的时候就会抛出一个&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">SyntaxError</span>。python 中有一个 <a href="https://docs.python.org/3.5/library/parser.html">parser</a> 模块提供了对 parse tree 的有限访问：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566885945893_1613" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; import parser
&gt;&gt;&gt; from pprint import pprint
&gt;&gt;&gt; code_str = """
... def hello_world():
...     return 'hello world'
... """
&gt;&gt;&gt; st = parser.suite(code_str)
&gt;&gt;&gt; pprint(parser.st2list(st))
[257,
 [269,
  [295,
   [263,
    [1, 'def'],
    [1, 'hello_world'],
    [264, [7, '('], [8, ')']],
    [11, ':'],
    [304,
     [4, ''],
     [5, ''],
     [269,
      [270,
       [271,
        [278,
         [281,
          [1, 'return'],
          [331,
           [305,
            [309,
             [310,
              [311,
               [312,
                [315,
                 [316,
                  [317,
                   [318,
                    [319,
                     [320,
                      [321,
                       [322,
                        [323, [324, [3, "'hello world'"]]]]]]]]]]]]]]]]]]]],
       [4, '']]],
     [6, '']]]]],
 [4, ''],
 [0, '']]</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566885945893_1613"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 1064px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>44</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>44</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">import</span> <span class="cm-variable">parser</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">from</span> <span class="cm-variable">pprint</span> <span class="cm-keyword">import</span> <span class="cm-variable">pprint</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">code_str</span> <span class="cm-operator">=</span> <span class="cm-string">"""</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-string">... def hello_world():</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-string">... &nbsp; &nbsp; return 'hello world'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-string">... """</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">st</span> <span class="cm-operator">=</span> <span class="cm-variable">parser</span>.<span class="cm-property">suite</span>(<span class="cm-variable">code_str</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">pprint</span>(<span class="cm-variable">parser</span>.<span class="cm-property">st2list</span>(<span class="cm-variable">st</span>))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">[<span class="cm-number">257</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> [<span class="cm-number">269</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">  [<span class="cm-number">295</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; [<span class="cm-number">263</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  [<span class="cm-number">1</span>, <span class="cm-string">'def'</span>],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  [<span class="cm-number">1</span>, <span class="cm-string">'hello_world'</span>],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  [<span class="cm-number">264</span>, [<span class="cm-number">7</span>, <span class="cm-string">'('</span>], [<span class="cm-number">8</span>, <span class="cm-string">')'</span>]],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  [<span class="cm-number">11</span>, <span class="cm-string">':'</span>],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  [<span class="cm-number">304</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; [<span class="cm-number">4</span>, <span class="cm-string">''</span>],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; [<span class="cm-number">5</span>, <span class="cm-string">''</span>],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">20</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; [<span class="cm-number">269</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">21</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [<span class="cm-number">270</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">22</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; [<span class="cm-number">271</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">23</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  [<span class="cm-number">278</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">24</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; [<span class="cm-number">281</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">25</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-number">1</span>, <span class="cm-string">'return'</span>],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">26</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-number">331</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">27</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="cm-number">305</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">28</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-number">309</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">29</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="cm-number">310</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">30</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-number">311</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">31</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="cm-number">312</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">32</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-number">315</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">33</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="cm-number">316</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">34</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-number">317</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">35</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="cm-number">318</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">36</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-number">319</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">37</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="cm-number">320</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">38</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-number">321</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">39</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<span class="cm-number">322</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">40</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-number">323</span>, [<span class="cm-number">324</span>, [<span class="cm-number">3</span>, <span class="cm-string">"'hello world'"</span>]]]]]]]]]]]]]]]]]]]],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">41</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; [<span class="cm-number">4</span>, <span class="cm-string">''</span>]]],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">42</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; [<span class="cm-number">6</span>, <span class="cm-string">''</span>]]]]],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">43</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> [<span class="cm-number">4</span>, <span class="cm-string">''</span>],</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">44</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> [<span class="cm-number">0</span>, <span class="cm-string">''</span>]]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 1064px;"></div><div class="CodeMirror-gutters" style="height: 1094px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><blockquote><div><span data-wiz-span="data-wiz-span" style="color: rgb(53, 60, 71);">代码清单 1.3.2</span></div></blockquote><div style="text-align: left;">函数调用&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">parser.suite(source)</span>&nbsp;会返回一个 python 中对 parser tree 的中间表示即 parser tree <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">(ST)</span> 对象。之后的调用&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">parser.st2list</span>&nbsp;会将 parser 以 list 的形式返回。list 中第一个元素为一个 int 类型的数字表示 python grammar 中对应的 <a href="https://github.com/python/cpython/blob/3.5/Include/token.h#L12">identifier 编号</a>。&nbsp;</div><div><img alt="Figure 3.0: A parse tree for listing 3.2 (function that returns the 'hello world' string)" src="Inside The Python Virtual Machine（前三章翻译）_files/e3dcae82-23ba-41ad-a076-d75a64958bfe.png"><br></div><blockquote><div style="text-align: left;"><span data-wiz-span="data-wiz-span" style="color: rgb(53, 60, 71);">图1.3.2：代码清单 1.3.2 中所展示的 parse tree 的图形化展示</span></div></blockquote><div>上图展示了代码清单1.3.2中产生的 parse tree 结构，可以看到其中每个节点的类型可以用一个整数来表示，这些对于这些整数的定义位于头文件&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Include/token.h">Include/token.h</a></span>&nbsp;和&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Include/graminit.h">Include/graminit.h</a></span>&nbsp;中。</div><div>在 CPython 虚拟机中，使用树数据结构来对 parser tree 进行表示。每一个产生式规则（production rule）是树中的一个节点（node）。对 node 的定义位于头文件&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Include/node.h#L10">Include/node.h</a></span>&nbsp;中。</div><div data-mode="Shell" data-theme="default" id="wiz_cm_1566888269858_9215" class="wiz-code-container"><textarea style="display:none;">typedef struct _node {
    short		n_type;
    char		*n_str;
    int			n_lineno;
    int			n_col_offset;
    int			n_nchildren;
    struct _node	*n_child;
} node;</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566888269858_9215"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 200px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">typedef struct _node {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  short<span class="cm-tab">   </span><span class="cm-tab">    </span>n_type;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  char<span class="cm-tab">    </span><span class="cm-tab">    </span>*n_str;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  int<span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-tab">    </span>n_lineno;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  int<span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-tab">    </span>n_col_offset;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  int<span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-tab">    </span>n_nchildren;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  struct _node<span class="cm-tab">    </span>*n_child;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">} <span class="cm-builtin">node</span>;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 200px;"></div><div class="CodeMirror-gutters" style="height: 230px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div>可以对 parser tree 进行遍历，访问节点的 类型、子节点、行号等等，这些操作以<span>宏（macro）的形式定义在</span>头文件&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">Include/node.h</span>&nbsp;中，用于与 parse tree 的节点进行交互。</div><h4>1.3.3 从 parse tree 到 AST</h4><div>生成 parse tree 之后的下一步是将其转换成 AST（抽象语法树，Abstract Syntax Tree）。AST 是一种与语法细节无关的代码表示，比如说图1.3.2中的 parse tree 中有一个逗号节点（colon node），因为它属于其中的语法构造（syntax construct），但是 AST 中将不会包含这样的语法构造：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566889714235_1306" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; import ast
&gt;&gt;&gt; node = ast.parse(code_str, mode='exec')
&gt;&gt;&gt; ast.dump(node)
"Module(body=[FunctionDef(name='hello_world', args=arguments(args=[], vararg=None, kwonlyargs=[], kw_defaults=[], kwarg=None, defaults=[]), body=[Return(value=Str(s='hello world'))], decorator_list=[], returns=None)])"</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566889714235_1306"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 149px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">import</span> <span class="cm-variable">ast</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">node</span> <span class="cm-operator">=</span> <span class="cm-variable">ast</span>.<span class="cm-property">parse</span>(<span class="cm-variable">code_str</span>, <span class="cm-variable">mode</span><span class="cm-operator">=</span><span class="cm-string">'exec'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">ast</span>.<span class="cm-property">dump</span>(<span class="cm-variable">node</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-string">"Module(body=[FunctionDef(name='hello_world', args=arguments(args=[], vararg=None, kwonlyargs=[], kw_defaults=[], kwarg=None, defaults=[]), body=[Return(value=Str(s='hello world'))], decorator_list=[], returns=None)])"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 149px;"></div><div class="CodeMirror-gutters" style="height: 179px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div>AST 节点的定义可以在&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Parser/Python.asdl">Parser/Python.asdl</a></span> 文件中找到（译注：ASDL 是一种用来描述 AST 的语言，可以参考 Eli Bendersky 的这篇<a href="https://eli.thegreenplace.net/2014/06/04/using-asdl-to-describe-asts-in-compilers">博文</a>）。AST 中几乎所有的定义都与特定的语法构造有关比如&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">if</span> 语句或者属性查找（attribute lookup）。python 的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://docs.python.org/3.5/library/ast.html">ast</a></span> 模块通过与解释器的绑定为我们提供了操作 AST 的能力。还有一些像 <a href="https://github.com/andreif/codegen">codegen</a> 这样的工具可以接受一个 AST 对象然后输出对应的 python 源代码。 在 CPython 的实现中 AST 节点以 C 结构体的形式定义在&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Include/Python-ast.h">Include/Python-ast.h</a></span> 之中。实际上，这些结构体是通过 python 代码生成的，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Parser/asdl_c.py">Parser/asdl_c.py</a></span> 模块可以根据 AST 的 asdl 定义来生成它们。比如说，语句（statement）节点的结构体一部分定义如下：</div><div data-mode="C" data-theme="default" id="wiz_cm_1566896499693_9671" class="wiz-code-container"><textarea style="display:none;">struct _stmt {
    enum _stmt_kind kind;
    union {
        struct {
            identifier name;
            arguments_ty args;
            asdl_seq *body;
            asdl_seq *decorator_list;
            expr_ty returns;
        } FunctionDef;
        
        struct {
            identifier name;
            arguments_ty args;
            asdl_seq *body;
            asdl_seq *decorator_list;
            expr_ty returns;
        } AsyncFunctionDef;
        
        struct {
            identifier name;
            asdl_seq *bases;
            asdl_seq *keywords;
            asdl_seq *body;
            asdl_seq *decorator_list;
        } ClassDef;
        ...
    } v;
    int lineno;
    int col_offset;
};</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566896499693_9671"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 752px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>31</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>31</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">_stmt</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">enum</span> <span class="cm-def">_stmt_kind</span> <span class="cm-def">kind</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">union</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">struct</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">identifier</span> <span class="cm-variable">name</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-type">arguments_ty</span> <span class="cm-variable">args</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">asdl_seq</span> <span class="cm-operator">*</span><span class="cm-variable">body</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">asdl_seq</span> <span class="cm-operator">*</span><span class="cm-variable">decorator_list</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-type">expr_ty</span> <span class="cm-variable">returns</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-variable">FunctionDef</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">struct</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">identifier</span> <span class="cm-variable">name</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-type">arguments_ty</span> <span class="cm-variable">args</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">asdl_seq</span> <span class="cm-operator">*</span><span class="cm-variable">body</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">asdl_seq</span> <span class="cm-operator">*</span><span class="cm-variable">decorator_list</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-type">expr_ty</span> <span class="cm-variable">returns</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-variable">AsyncFunctionDef</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">20</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">struct</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">21</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">identifier</span> <span class="cm-variable">name</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">22</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">asdl_seq</span> <span class="cm-operator">*</span><span class="cm-variable">bases</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">23</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">asdl_seq</span> <span class="cm-operator">*</span><span class="cm-variable">keywords</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">24</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">asdl_seq</span> <span class="cm-operator">*</span><span class="cm-variable">body</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">25</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">asdl_seq</span> <span class="cm-operator">*</span><span class="cm-variable">decorator_list</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">26</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-variable">ClassDef</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">27</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">28</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;  } <span class="cm-variable">v</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">29</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">lineno</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">30</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">col_offset</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">31</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 752px;"></div><div class="CodeMirror-gutters" style="height: 782px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div>上面的代码中， union 类型用来表示任意一个位于其中的 C 类型。文件&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">Python/ast.c</span>&nbsp;中的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/ast.c#L817">PyAST_FromNode</a></span>&nbsp;函数能够根据一个 parse_tree 来生成 AST。生成 AST 之后，下一步就是根据 AST 来生成字节码了。</div><h4>1.3.4 构建符号表</h4><div><span>生成&nbsp;</span>AST 之后的下一步是生成符号表（symbol table）。符号表就如同它的名字所暗示的那样，是一个代码块（code block）与上下文（context）中所使用到的名字的集合。符号表的构建过程涉及到对一个代码块中所包含的所有名字以及对这些名字正确作用域赋值的分析。<span>为了避免误解，</span>在讨论复杂的符号表生成之前，我们<span>要</span>首先对<span>一些与</span>名字（names）、绑定（bindings）相关的概念进行讨论：</div><div><hr></div><h5>1.3.4.1 Names and binding</h5><div>在 python 中，对象通过名字进行引用，虽然有点像，但&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">names</span>&nbsp;与 C++ 与 Java 中变量并不一样。</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566898006106_8291" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; x = 5</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566898006106_8291"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 32px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-number">5</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 32px;"></div><div class="CodeMirror-gutters" style="height: 62px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">在上面的代码中，<span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">x</span>&nbsp;其实是一个对于对象&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">5</span>&nbsp;的引用。将对象&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">5</span>&nbsp;的引用赋值给名字（name）&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">x</span>&nbsp;的过程称之为绑定（binding）。一个绑定行为所产生的结果是一个名字在执行过程中最内层的作用域中与一个对象产生关联。绑定可能发生在几个不同的情况下，比如在变量赋值过程中，或是发生在函数或者方法调用时实参与型参的绑定。有一点很重要的，需要注意的是名字只是符号，它们并没有与类型相关联，名字只是对带有类型的对象的引用而已。</div><h6>1.3.4.1.1 Code Blocks</h6><div style="text-align: left;">代码块（code blocks）是 python 程序的重要概念之一，对它的理解对于理解 python 虚拟机的内部机制来说非常重要。代码块是一个能够在 python 中作为一个独立单元执行的代码片段，比如模块、函数和类。REPL 中的命令类型，命令行中使用&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">-c</span> 参数执行的脚本命令也是代码块。一个代码块由多个与它相关的 namespace ，比如说，一个模块代码块能够访问&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">global</span>&nbsp;namespace，一个函数代码块可以同时访问&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">local</span>&nbsp;和&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">global</span>&nbsp;namespace。</div><h6>1.3.4.1.2 Namespaces</h6><div style="text-align: left;">一个 namespace 就像它的名字暗示的那样，可以理解为一个环境（context）在其中，一系列名字与对象被绑定在一起。比如说 builtin namespace 是一个包含了所有 built-in 函数的 namespace，它可以通过&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">__builtins__.__dict__</span>&nbsp;被访问。解释器能够访问多个 namespace 包括 global, builtin, local。这些 namespace 在不同的时间点被创建，具有不同的生命周期。比如说，一个新的 local namespace 在一个函数调用时创建，在一个函数退出或者返回时销毁。global namespace 在一个模块开始执行的时候被创建并且所有定义在其中的名字能够在模块级别上进行访问。而 built-in namespace 则是在解释器被调用的时候就被创建，并且其中包含了所有的 builtin names。这三者是 python 解释器中所主要使用的 namespace。</div><div style="text-align: left;">&nbsp;<span style="color: rgb(119, 119, 119); font-weight: bold;">1.3.4.1.3 Scopes</span></div><div style="text-align: left;">一个作用域（scope）是程序中的一块区域，在作用域中 namespace 可以不通过任何的 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">.</span>&nbsp;（dot notaion）直接访问。在运行时（runtime）中存在以下几种作用域：</div><div style="text-align: left;"><ol class="wiz-list-level1"><li>局部命名空间的最内层的作用域。</li><li>闭合函数（enclosing functions）作用域（在存在嵌套函数时有用）。</li><li>当前模块的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">globals</span>&nbsp;作用域。</li><li>包含 builtin namespace 的作用域。</li></ol></div><div style="text-align:left">当一个名字在 python 中可用时，解释器会在 scope 的 namespace 中以由内到外的顺序进行搜索，如果在所有的 namespaces 中都没有找到，就会抛出一个 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">NameError</span> 异常。 Python 支持静态作用域（static scoping）也被称之为词法作用域（lexical scoping），也就是说仅通过对程序代码的检查就可以推导出命名绑定。</div><div style="text-align:left"><hr></div><h6>1.3.4.a 补充：未定义行为，在函数内修改 locals()</h6><div style="text-align: left;">请思考以下代码为什么会报错：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566910572250_6996" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; def func1():
...     locals()['a'] = 1
...     print(locals()['a'])
...     print(a)
...     return locals()
... 
&gt;&gt;&gt; func1()
1
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "&lt;stdin&gt;", line 4, in func1
NameError: name 'a' is not defined</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566910572250_6996"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 296px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>12</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>12</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">def</span> <span class="cm-def">func1</span>():</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">locals</span>()[<span class="cm-string">'a'</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">print</span>(<span class="cm-builtin">locals</span>()[<span class="cm-string">'a'</span>])</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">print</span>(<span class="cm-variable">a</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">return</span> <span class="cm-builtin">locals</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">func1</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">Traceback</span> (<span class="cm-variable">most</span> <span class="cm-variable">recent</span> <span class="cm-variable">call</span> <span class="cm-variable">last</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable cm-error">File</span> <span class="cm-string">"&lt;stdin&gt;"</span>, <span class="cm-variable">line</span> <span class="cm-number">1</span>, <span class="cm-keyword">in</span> <span class="cm-operator">&lt;</span><span class="cm-variable">module</span><span class="cm-operator">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">File</span> <span class="cm-string">"&lt;stdin&gt;"</span>, <span class="cm-variable">line</span> <span class="cm-number">4</span>, <span class="cm-keyword">in</span> <span class="cm-variable">func1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">NameError</span>: <span class="cm-variable">name</span> <span class="cm-string">'a'</span> <span class="cm-keyword">is</span> <span class="cm-keyword">not</span> <span class="cm-variable">defined</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 296px;"></div><div class="CodeMirror-gutters" style="height: 326px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">这是一个 Python 中的未定义行为，可以参考 <a href="https://www.python.org/dev/peps/pep-0558/">PEP558</a>&nbsp;。</div><div style="text-align: left;"><hr><b>注意：</b></div><div style="text-align: left;">Python 中存在一个作用域规则看起来有些奇怪，它会阻止在 local 作用域中修改 global 作用域中的对象。如果发现有这样的行为，解释器会抛出一个&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">UnboundLocalError</span>&nbsp;异常：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566914035927_1547" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; a = 1
&gt;&gt;&gt; def inc_a(): a += 1
... 
&gt;&gt;&gt; inc_a()
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "&lt;stdin&gt;", line 1, in inc_a
UnboundLocalError: local variable 'a' referenced before assignment</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566914035927_1547"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 200px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">a</span> <span class="cm-operator">=</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">def</span> <span class="cm-def">inc_a</span>(): <span class="cm-variable">a</span> <span class="cm-operator">+=</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">inc_a</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">Traceback</span> (<span class="cm-variable">most</span> <span class="cm-variable">recent</span> <span class="cm-variable">call</span> <span class="cm-variable">last</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable cm-error">File</span> <span class="cm-string">"&lt;stdin&gt;"</span>, <span class="cm-variable">line</span> <span class="cm-number">1</span>, <span class="cm-keyword">in</span> <span class="cm-operator">&lt;</span><span class="cm-variable">module</span><span class="cm-operator">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">File</span> <span class="cm-string">"&lt;stdin&gt;"</span>, <span class="cm-variable">line</span> <span class="cm-number">1</span>, <span class="cm-keyword">in</span> <span class="cm-variable">inc_a</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-variable">UnboundLocalError</span>: <span class="cm-variable">local</span> <span class="cm-variable">variable</span> <span class="cm-string">'a'</span> <span class="cm-variable">referenced</span> <span class="cm-variable">before</span> <span class="cm-variable">assignment</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 200px;"></div><div class="CodeMirror-gutters" style="height: 230px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;"><span>为了能够在局部作用域中对全局作用域中的对象进行修改，需要使用&nbsp;</span><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">global</span><span><span>&nbsp;</span>关键字：</span><br></div><div data-mode="Python" data-theme="default" id="wiz_cm_1566914071088_5186" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; a = 1
&gt;&gt;&gt; def inc_a():
...     global a
...     a += 1
... 
&gt;&gt;&gt; inc_a()
&gt;&gt;&gt; a
2</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566914071088_5186"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 200px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">a</span> <span class="cm-operator">=</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">def</span> <span class="cm-def">inc_a</span>():</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">global</span> <span class="cm-variable">a</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">a</span> <span class="cm-operator">+=</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">inc_a</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">a</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">2</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 200px;"></div><div class="CodeMirror-gutters" style="height: 230px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;"><span>Python 中还有一个&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">nonlocal</span>&nbsp;关键字用来在内层的作用域中修改一个外层的非全局作用域。这在编写嵌套函数（或者说是闭包（closure））时非常有用。下面是一个简单的例子对&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">nonlocal</span>&nbsp;的行为进行说明：</span></div><div data-mode="Python" data-theme="default" id="wiz_cm_1566914562231_1323" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; def make_counter():
...     count = 0
...     def counter():
...         nonlocal count
...         count += 1
...         return count
...     return counter
... 
&gt;&gt;&gt; counter_1 = make_counter()
&gt;&gt;&gt; counter_2 = make_counter()
&gt;&gt;&gt; counter_1()
1
&gt;&gt;&gt; counter_1()
2
&gt;&gt;&gt; counter_2()
1
&gt;&gt;&gt; counter_2()
2</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566914562231_1323"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 440px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>18</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>18</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-keyword">def</span> <span class="cm-def">make_counter</span>():</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">count</span> <span class="cm-operator">=</span> <span class="cm-number">0</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">def</span> <span class="cm-variable">counter</span>():</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-property">nonlocal</span> <span class="cm-variable">count</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-property">count</span> <span class="cm-operator">+=</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-property">return</span> <span class="cm-variable">count</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... &nbsp; &nbsp; <span class="cm-property">return</span> <span class="cm-variable">counter</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">... </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">counter_1</span> <span class="cm-operator">=</span> <span class="cm-variable">make_counter</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">counter_2</span> <span class="cm-operator">=</span> <span class="cm-variable">make_counter</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">counter_1</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">counter_1</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">2</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">counter_2</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">counter_2</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-number">2</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 440px;"></div><div class="CodeMirror-gutters" style="height: 470px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">至此，我们对 python 中的名字（names）与绑定（binding）相关的一些概念进行了讨论，我们接着来看如何根据 AST 生成符号表。</div><div style="text-align: left;"><hr>符号表的创建涉及到一系列的函数调用：</div><div style="text-align: left;"><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">run_mod -&gt; PyAST_CompileObject -&gt; PySymtable_BuildObject</span><br></div><div style="text-align: left;">函数&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/symtable.c#L234">PySymtable_BuildObject</a></span>&nbsp;所接受的两个参数分别是之前生成的 AST 对象与该模块的文件名。符号表创建算法可以分为两个步骤。在第一个步骤中，被作为参数传递给&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">PySymtable_BuildObject</span>&nbsp;的 AST 中的每个节点会被按照顺序遍历，然后创建出一系列在 AST 中被使用的符号。下面的伪代码对这个过程进行了简单的描述，关于其中涉及到的术语，比如符号表（symbol table）与符号表项目（symbol table entry）在后面会有更详细的说明：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566915575913_5030" class="wiz-code-container"><textarea style="display:none;">for node in AST:  # 遍历 AST
    if (node 是一个 code block 的起始):
        ste = 新建符号表项目()
        st.st_stack.push(ste)  # 新的符号表入栈
        st.current_ste.children.append(st)  # 将新表项加入上一个表项的子表项
        st.current_ste = ste  # 将符号表的 当前表项 设置为新建的符号表项
        for node1 in code_block.nodes:  # 遍历 code_block 里的所有节点
            # 递归访问 node1 创建符号加入表项中， XXX 是 node1 的类型
            symtable_visit_XXX(node1)
        st.st_stack.pop()  # 将当前表项移出栈
        st.current_st = st_stack.pop()
    else:
        递归访问 node 与 sub_nodes(node) 创建符号加入符号表</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566915575913_5030"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 320px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">node</span> <span class="cm-keyword">in</span> <span class="cm-variable">AST</span>: &nbsp;<span class="cm-comment"># 遍历 AST</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">node</span> <span class="cm-variable">是一个</span> <span class="cm-variable">code</span> <span class="cm-variable">block</span> <span class="cm-variable">的起始</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ste</span> <span class="cm-operator">=</span> <span class="cm-variable">新建符号表项目</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">st</span>.<span class="cm-property">st_stack</span>.<span class="cm-property">push</span>(<span class="cm-variable">ste</span>) &nbsp;<span class="cm-comment"># 新的符号表入栈</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">st</span>.<span class="cm-property">current_ste</span>.<span class="cm-property">children</span>.<span class="cm-property">append</span>(<span class="cm-variable">st</span>) &nbsp;<span class="cm-comment"># 将新表项加入上一个表项的子表项</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">st</span>.<span class="cm-property">current_ste</span> <span class="cm-operator">=</span> <span class="cm-variable">ste</span> &nbsp;<span class="cm-comment"># 将符号表的 当前表项 设置为新建的符号表项</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">node1</span> <span class="cm-keyword">in</span> <span class="cm-variable">code_block</span>.<span class="cm-property">nodes</span>: &nbsp;<span class="cm-comment"># 遍历 code_block 里的所有节点</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 递归访问 node1 创建符号加入表项中， XXX 是 node1 的类型</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">symtable_visit_XXX</span>(<span class="cm-variable">node1</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">st</span>.<span class="cm-property">st_stack</span>.<span class="cm-property">pop</span>() &nbsp;<span class="cm-comment"># 将当前表项移出栈</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">st</span>.<span class="cm-property">current_st</span> <span class="cm-operator">=</span> <span class="cm-variable">st_stack</span>.<span class="cm-property">pop</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">else</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">递归访问</span> <span class="cm-variable">node</span> <span class="cm-variable">与</span> <span class="cm-variable">sub_nodes</span>(<span class="cm-variable">node</span>) <span class="cm-variable">创建符号加入符号表</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 320px;"></div><div class="CodeMirror-gutters" style="height: 350px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">在第一轮在 AST 上进行的算法完成后，符号表内已经包含了模块中使用的所有名字 ，但并不包含这些名字的上下文信息。比如说，解释器不能告诉你一个给定的变量是一个全局变量，局部变量还是自由变量（free variables）。符号表生成的第二阶段从一个对&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">Python/symtable.c</span>&nbsp;中&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/symtable.c#L890">symtable_analyze</a></span>&nbsp;函数的调用开始。这个阶段的算法将对第一个阶段中产生的符号分配作用域（local, global, free）。<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">Parser/symtable.c</span>&nbsp;文件中的注释的信息十分丰富，特别是下面的这些节选，对第二阶段进行了很好的说明：</div><div style="text-align: left;"><blockquote style="font-size:1.125rem;color:rgb(139, 139, 139);"><p style="font-size:1rem;font-family:&quot;Noto Serif&quot;, serif;">The symbol table requires two passes to determine the scope of each name. The first pass collects raw facts from the AST via the symtable_visit_* functions while the second pass analyzes these facts during a pass over the PySTEntryObjects created during pass 1.</p></blockquote><blockquote style="font-size:1.125rem;color:rgb(139, 139, 139);"><p style="font-size:1rem;font-family:&quot;Noto Serif&quot;, serif;">When a function is entered during the second pass, the parent passes the set of all name bindings visible to its children. These bindings are used to determine if non-local variables are free or implicit globals. Names which are explicitly declared nonlocal must exist in this set of visible names - if they do not, a syntax error is raised. After doing the local analysis, it analyzes each of its child blocks using an updated set of name bindings.</p></blockquote><blockquote style="font-size:1.125rem;color:rgb(139, 139, 139);"><p style="font-size:1rem;font-family:&quot;Noto Serif&quot;, serif;">There are also two kinds of global variables, implicit and explicit. An explicit global is declared with the global statement. An implicit global is a free variable for which the compiler has found no binding in an enclosing function scope. The implicit global is either a global or a builtin.<br>Python’s module and class blocks use the<span>&nbsp;</span><code style="font-size:0.9rem;font-family:&quot;Lucida Console&quot;, monospace;background:rgb(239, 239, 239);color:rgb(0, 0, 0);">xxx_NAME</code><span>&nbsp;</span>opcodes to handle these names to implement slightly odd semantics. In such a block, the name is treated as global until it is assigned to; then it is treated as a local.</p></blockquote><blockquote style="font-size: 1.125rem; font-family: &quot;Noto Serif&quot;, serif; color: rgb(139, 139, 139);"><p style="font-size:1rem;font-family:&quot;Noto Serif&quot;, serif;">The children update the free variable set. If a local variable is added to the free variable set by the child, the variable is marked as a cell. The function object being defined must provide runtime storage for the variable that may outlive the function’s frame. Cell variables are removed from the free set before the analyze function returns to its parent.</p></blockquote>尽管这些注释试图用清晰的语言来解释这个过程，但其中仍然存在一些歧义，比如：&nbsp;<em style="font-style: italic; font-size: 1.125rem; font-family: &quot;Noto Serif&quot;, serif;">passes the set of all name bindings visible to its children</em>&nbsp;，这里的 parent 与 children 指的到底是什么？为了理解这些术语，我们来看一看符号表的数据结构。<br></div><h4>1.3.5 符号表数据结构</h4><div style="text-align: left;">符号表生成过程中有两个核心的<span>数据结构：</span></div><div style="text-align: left;"><ol class="wiz-list-level1"><li>The symbol table data structure.（符号表）</li><li>The symbol table entry data structure.（符号表项目）</li></ol></div><div style="text-align:left">符号表数据结构定义在头文件 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Include/symtable.h#L18">Include/symtable.h</a></span> 中，我们可以认为符号表由一系列持有给定模块中不同 code blocks 信息的表项所组成。</div><div data-mode="C" data-theme="default" id="wiz_cm_1566920165014_8569" class="wiz-code-container"><textarea style="display:none;">struct symtable {
    PyObject *st_filename;          /* name of file being compiled,
                                       decoded from the filesystem encoding */
    struct _symtable_entry *st_cur; /* current symbol table entry */
    struct _symtable_entry *st_top; /* symbol table entry for module */
    PyObject *st_blocks;            /* dict: map AST node addresses
                                     *       to symbol table entries */
    PyObject *st_stack;             /* list: stack of namespace info */
    PyObject *st_global;            /* borrowed ref to st_top-&gt;ste_symbols */
    int st_nblocks;                 /* number of blocks used. kept for
                                       consistency with the corresponding
                                       compiler structure */
    PyObject *st_private;           /* name of current class or NULL */
    PyFutureFeatures *st_future;    /* module's future features that affect
                                       the symbol table */
    int recursion_depth;            /* current recursion depth */
    int recursion_limit;            /* recursion limit */
};</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566920165014_8569"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 440px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>18</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>18</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">symtable</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">st_filename</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* name of file being compiled,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">decoded from the filesystem encoding */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">_symtable_entry</span> <span class="cm-operator">*</span><span class="cm-variable">st_cur</span>; <span class="cm-comment">/* current symbol table entry */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">_symtable_entry</span> <span class="cm-operator">*</span><span class="cm-type">st_top</span>; <span class="cm-comment">/* symbol table entry for module */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">st_blocks</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* dict: map AST node addresses</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">* &nbsp; &nbsp; &nbsp; to symbol table entries */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">st_stack</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">/* list: stack of namespace info */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">st_global</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* borrowed ref to st_top-&gt;ste_symbols */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">st_nblocks</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">/* number of blocks used. kept for</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">consistency with the corresponding</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">compiler structure */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">st_private</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">/* name of current class or NULL */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyFutureFeatures</span> <span class="cm-operator">*</span><span class="cm-variable">st_future</span>; &nbsp; &nbsp;<span class="cm-comment">/* module's future features that affect</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">the symbol table */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">recursion_depth</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* current recursion depth */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">recursion_limit</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* recursion limit */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 440px;"></div><div class="CodeMirror-gutters" style="height: 470px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">一个 python 模块可能包含多个 code block，比如多个函数定义。结构体中的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">st_blocks</span>&nbsp;字段是一个所有 code block （AST node）到符号表项的映射。<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">st_top</span>&nbsp;字段是一个符号表项，对应于一个被编译的模块（注意模块也是一个 code block），所以它将包含所有定义在模块 global namespace 中的名字。<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">st_cur</span>&nbsp;字段指向一个符号表项目，该表项对应于正在被处理的 code block（AST node）。模块中的每一个 code block 有一个它自己的符号表项，它持有所有定义在其中的符号。</div><div style="text-align: left;"><img alt="Figure 3.1: A Symbol table and symbol table entries." src="Inside The Python Virtual Machine（前三章翻译）_files/0e20557c-2ee7-4127-ad89-83f5c349fb10.png"><br></div><blockquote><div style="text-align: left;"><span data-wiz-span="data-wiz-span" style="color: rgb(153, 153, 153);">图1.3.5: 一个符号表（symbol table）与符号表项（symbol table entry）的图形化展示</span></div></blockquote><div style="text-align: left;">再来看一下&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">Include/symtable.h</span>&nbsp;中&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Include/symtable.h#L37">_symtable_entry</a></span>&nbsp;的定义，对于理解这个数据结构的作用很有帮助：</div><div data-mode="C" data-theme="default" id="wiz_cm_1566921389738_5012" class="wiz-code-container"><textarea style="display:none;">typedef struct _symtable_entry {
    PyObject_HEAD
    PyObject *ste_id;        /* int: key in ste_table-&gt;st_blocks */
    PyObject *ste_symbols;   /* dict: variable names to flags */
    PyObject *ste_name;      /* string: name of current block */
    PyObject *ste_varnames;  /* list of function parameters */
    PyObject *ste_children;  /* list of child blocks */
    PyObject *ste_directives;/* locations of global and nonlocal statements */
    _Py_block_ty ste_type;   /* module, class, or function */
    int ste_nested;      /* true if block is nested */
    unsigned ste_free : 1;        /* true if block has free variables */
    unsigned ste_child_free : 1;  /* true if a child block has free vars,
                                     including free refs to globals */
    unsigned ste_generator : 1;   /* true if namespace is a generator */
    unsigned ste_varargs : 1;     /* true if block has varargs */
    unsigned ste_varkeywords : 1; /* true if block has varkeywords */
    unsigned ste_returns_value : 1;  /* true if namespace uses return with
                                        an argument */
    unsigned ste_needs_class_closure : 1; /* for class scopes, true if a
                                             closure over __class__
                                             should be created */
    int ste_lineno;          /* first line of block */
    int ste_col_offset;      /* offset of first line of block */
    int ste_opt_lineno;      /* lineno of last exec or import * */
    int ste_opt_col_offset;  /* offset of last exec or import * */
    int ste_tmpname;         /* counter for listcomp temp vars */
    struct symtable *ste_table;
} PySTEntryObject;</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566921389738_5012"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 680px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>28</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>28</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-def">_symtable_entry</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject_HEAD</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">ste_id</span>; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* int: key in ste_table-&gt;st_blocks */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">ste_symbols</span>; &nbsp; <span class="cm-comment">/* dict: variable names to flags */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">ste_name</span>; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* string: name of current block */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">ste_varnames</span>; &nbsp;<span class="cm-comment">/* list of function parameters */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">ste_children</span>; &nbsp;<span class="cm-comment">/* list of child blocks */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">ste_directives</span>;<span class="cm-comment">/* locations of global and nonlocal statements */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">_Py_block_ty</span> <span class="cm-type">ste_type</span>; &nbsp; <span class="cm-comment">/* module, class, or function */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">ste_nested</span>; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* true if block is nested */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">ste_free</span> : <span class="cm-number">1</span>; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* true if block has free variables */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">ste_child_free</span> : <span class="cm-number">1</span>; &nbsp;<span class="cm-comment">/* true if a child block has free vars,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">including free refs to globals */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">ste_generator</span> : <span class="cm-number">1</span>; &nbsp; <span class="cm-comment">/* true if namespace is a generator */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">ste_varargs</span> : <span class="cm-number">1</span>; &nbsp; &nbsp; <span class="cm-comment">/* true if block has varargs */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">ste_varkeywords</span> : <span class="cm-number">1</span>; <span class="cm-comment">/* true if block has varkeywords */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">ste_returns_value</span> : <span class="cm-number">1</span>; &nbsp;<span class="cm-comment">/* true if namespace uses return with</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">an argument */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">ste_needs_class_closure</span> : <span class="cm-number">1</span>; <span class="cm-comment">/* for class scopes, true if a</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">20</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">closure over __class__</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">21</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">should be created */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">22</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">ste_lineno</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* first line of block */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">23</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">ste_col_offset</span>; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* offset of first line of block */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">24</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">ste_opt_lineno</span>; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* lineno of last exec or import * */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">25</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">ste_opt_col_offset</span>; &nbsp;<span class="cm-comment">/* offset of last exec or import * */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">26</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-type">ste_tmpname</span>; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">/* counter for listcomp temp vars */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">27</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">symtable</span> <span class="cm-operator">*</span><span class="cm-type">ste_table</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">28</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">} <span class="cm-variable">PySTEntryObject</span>;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 680px;"></div><div class="CodeMirror-gutters" style="height: 710px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">源码中每个字段后的注释对其进行了解释，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">ste_symbols</span>&nbsp;字段是 一个包含了该 code block 中所确认到的所有符号到 flag 的映射，其中 flag 是一个数值类型的值，它提供了符号在该环境中所具有的含义。比如，一个符号可能是一个函数参数或者是一个全局定义。flag 具体被定义在文件&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">Include/symtable.h</span>&nbsp;中，这里列出一部分作为示例：</div><div data-mode="C" data-theme="default" id="wiz_cm_1566922502238_9649" class="wiz-code-container"><textarea style="display:none;">/* Flags for def-use information */

#define DEF_GLOBAL 1           /* global stmt */
#define DEF_LOCAL 2            /* assignment in code block */
#define DEF_PARAM 2&lt;&lt;1         /* formal parameter */
#define DEF_NONLOCAL 2&lt;&lt;2      /* nonlocal stmt */
#define USE 2&lt;&lt;3               /* name is used */
#define DEF_FREE 2&lt;&lt;4          /* name used but not defined in nested block */</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566922502238_9649"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 200px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-comment">/* Flags for def-use information */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-meta">#define DEF_GLOBAL 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="cm-comment">/* global stmt */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-meta">#define DEF_LOCAL 2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-comment">/* assignment in code block */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-meta">#define DEF_PARAM 2&lt;&lt;1 &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="cm-comment">/* formal parameter */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-meta">#define DEF_NONLOCAL 2&lt;&lt;2 &nbsp; &nbsp; &nbsp;</span><span class="cm-comment">/* nonlocal stmt */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-meta">#define USE 2&lt;&lt;3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="cm-comment">/* name is used */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-meta">#define DEF_FREE 2&lt;&lt;4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-comment">/* name used but not defined in nested block */</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 200px;"></div><div class="CodeMirror-gutters" style="height: 230px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">回到我们对于符号表的讨论上，假设一个模块包含如下代码：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566922661204_7900" class="wiz-code-container"><textarea style="display:none;">def make_counter():
    count = 0
    def counter():
        nonlocal count
        count += 1
        return count
    return counter</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566922661204_7900"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 176px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">make_counter</span>():</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-number">0</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">counter</span>():</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">nonlocal</span> <span class="cm-variable">count</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">count</span> <span class="cm-operator">+=</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">count</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">counter</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="height: 206px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;"><span>那么它被编译后将产生三个符号表项。首先第一个表项是模块级别的表项，它将包含定义一个带有局部作用域的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">make_counter</span>&nbsp;。下一个表项将进入到&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">make_counter</span>&nbsp;函数中，它将包含定义在局部作用域中的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">count</span>&nbsp;和&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">counter</span>&nbsp;。最后一个表项将进入到嵌套定义的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">counter</span>&nbsp;函数，它包含一个被标记为&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">free</span> 的变量&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">count</span> 。值得注意的是虽然&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">make_counter</span>&nbsp;在模块 code block 表项中是局部的，但它会被看作是被全局定义在模块 code block 中，因为符号表的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">*st_global</span>&nbsp;字段指向了&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">*st_top</span>&nbsp;对应的符号也就是模块 code block 下的符号（st_top-&gt;ste_symbols）。</span><br></div><h4>1.3.6 从 AST 到 code object</h4><div style="text-align: left;">符号表生成之后，编译过程的下一步是根据 AST 以及符号表中的信息来生成 code object。负责这个过程处理的函数定义在文件&nbsp; <span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/compile.c">Python/compile.c</a></span>&nbsp;中。生成 code object 也是一个多步的过程。在第一步中，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">AST</span>&nbsp;被转化为 python 字节码指令的基础块（basic blocks）。这里使用的算法与生成符号表时的算法很相似。由一系列命名为&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">compiler_visit_xx</span>&nbsp;的函数来进行，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">xx</span>&nbsp;指的是节点的类型，这些函数会递归地访问每一个 AST 节点并在访问过程中产生 python 字节码指令的基础块。基础指令块以及块之间的路径被隐式的表示为图（graph）结构，也称之为控制流图（control flow graph，CFG）。这个图体现了在运行过程中的代码路径。然后进入 code object 生成的第二阶段，控制流图，以后缀深度优先遍历的方式将前一步生成的控制流图扁平化（flatten）。图被扁平化之后，跳转偏移量被计算出来作为&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">jump</span>&nbsp;指令的参数。然后再根据这些指令生成 code object，为了更好的理解这个过程，我们来看一看下面这个函数：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566969408154_5661" class="wiz-code-container"><textarea style="display:none;">def fizzbuzz(n):
    if n % 3 == 0 and n % 5 == 0: 
        return 'FizzBuzz'
    elif n % 3 == 0: 
        return 'Fizz'
    elif n % 5 == 0: 
        return 'Buzz'
    else: 
        return str(n)</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566969408154_5661"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 224px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">fizzbuzz</span>(<span class="cm-variable">n</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">n</span> <span class="cm-operator">%</span> <span class="cm-number">3</span> <span class="cm-operator">==</span> <span class="cm-number">0</span> <span class="cm-keyword">and</span> <span class="cm-variable">n</span> <span class="cm-operator">%</span> <span class="cm-number">5</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>: </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">'FizzBuzz'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">elif</span> <span class="cm-variable">n</span> <span class="cm-operator">%</span> <span class="cm-number">3</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>: </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">'Fizz'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">elif</span> <span class="cm-variable">n</span> <span class="cm-operator">%</span> <span class="cm-number">5</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>: </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">'Buzz'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">else</span>: </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">str</span>(<span class="cm-variable">n</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="height: 254px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">这个函数对应的 AST 如下所示：</div><div style="text-align: left;"><img alt="Figure 3.2: A very simple AST  for listing 3.2" src="Inside The Python Virtual Machine（前三章翻译）_files/e54e7b26-9c62-45e3-9574-f93f39d8ba6a.png"><br></div><blockquote><div style="text-align: left;"><span data-wiz-span="data-wiz-span" style="color: rgb(153, 153, 153);">图1.3.6.a fizzbuzz 函数的 AST 图示（译注：这里的 AST 画的有问题，应该只有最后一个分支对应 str(n) 调用前几个分支返回的都是字面量）</span></div></blockquote><div style="text-align: left;">上面的 AST 编译成的 CFG 类似于下图展示的那样，空块（empty）在图中已经被忽略。仔细看一下这个图可以得到一些关于基础块的理解。基础块有单一的入口与多个不同的出口，关于它后面还会做更详细的讨论。</div><div style="text-align: center;"><img alt="Figure 3.3: Control flow graph for the fizzbuzz function from listing 3.11. The straight line represent normal straight line execution of code while the  curved lines represent jumps." src="Inside The Python Virtual Machine（前三章翻译）_files/70037a0c-2565-4ee1-a1ec-dbe78f650fdd.png"><br></div><div style="text-align: left;"><span style="color: rgb(153, 153, 153);">图1.3.6.b fizzbuzz 函数对应的控制流图（CFG），其中的直线代表代码正常的运行顺序，曲线代表跳转。</span><br></div><div style="text-align: left;">下面的描述中，为了让我们更专注于所讨论的内容，我们省略了指令的参数。</div><div style="text-align: left;"><ol class="wiz-list-level1"><li>Block 1：这个块包含了映射到图 1.3.6.a 所示的 AST 中&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">BoolOp</span>&nbsp;节点的指令。在这个 block 中表达式&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">n%3==0 and n%5==0</span>&nbsp;通过以下七条指令实现：<div data-mode="Shell" data-theme="default" id="wiz_cm_1566971681157_1788" class="wiz-code-container"><textarea style="display:none;">             LOAD_FAST               
             LOAD_CONST              
             BINARY_MODULO
             LOAD_CONST              
             COMPARE_OP              
             JUMP_IF_FALSE_OR_POP    
             LOAD_FAST               
             LOAD_CONST              
             BINARY_MODULO
             LOAD_CONST              
             COMPARE_OP              </textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566971681157_1788"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 272px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>11</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>11</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_FAST &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_CONST &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BINARY_MODULO</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_CONST &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; COMPARE_OP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JUMP_IF_FALSE_OR_POP &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_FAST &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_CONST &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BINARY_MODULO</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_CONST &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; COMPARE_OP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 272px;"></div><div class="CodeMirror-gutters" style="height: 302px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div>令人惊讶的是&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">if</span>&nbsp;节点并没有包括在这个 block 中，原因将在 block2 的讨论中说明。如同图 1.3.6.b 中所示的那样，有两条途径离开这个 block：直接执行完毕后离开或者通过执行&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">JUMP_IF_FALSE_OR_POP</span> 指令跳转离开进入 block2。</div></li><li style="text-align: left;">Block2：这个 block 映射到第一个&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">if</span> 节点，封装了&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">if</span>&nbsp;的测试和后续的子句（clause）。block2 包含以下几条指令：<div data-mode="Shell" data-theme="default" id="wiz_cm_1566972790137_9278" class="wiz-code-container"><textarea style="display:none;">                 POP_JUMP_IF_FALSE
                 LOAD_CONST
                 RETURN_VALUE
                 JUMP_FORWARD</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566972790137_9278"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 104px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; POP_JUMP_IF_FALSE</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_CONST</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RETURN_VALUE</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JUMP_FORWARD</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 104px;"></div><div class="CodeMirror-gutters" style="height: 134px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div>在下面的章节中将会看到，当解释器执行&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">if</span> 语句的字节码指令的时候，它会从栈上读取一个对象根据对象的布尔值来决定执行下一条指令或者跳转到另一个地方继续执行那里的指令。指令&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">POP_JUMP_IF_FALSE</span>&nbsp;就是一个负责这个的跳转指令（opcode），它接受一个参数作为它跳转的目标地址。你可能会疑惑为什么&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">BoolOp</span>&nbsp;节点与&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">if</span>&nbsp;语句对应的不是同一个 block。还记得吗？python 中的 and 操作符是一个短路运算，所以当&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">n%3==0</span>&nbsp;被求值为 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">False</span> 的时候&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">n%5==0</span>&nbsp;将不会被求值。可以看一看 block1 中的指令，可以发现在第一个比较（comprasion）操作后面接着一条&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">JUMP_IF_FALSE_OR_POP</span>&nbsp;指令。这条指令是一种 jump 操作的变体因此需要一个跳转目标。这样子来看，第二个 block 的作用就很明显了，就是为上面的短路跳转提供一个地址，跳转的参数在扁平化的时候可以被计算出来。如果布尔表达式中的所有成份被求值完成，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">BoolOp</span>&nbsp;block 中的指令全部被执行之后，也会按照正常的顺序进入&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">if</span>&nbsp;语句的 block。</div></li><li>Block3：这个 block 映射到第一个&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">orElse</span>&nbsp;AST 节点，该节点包含以下9条指令：<div data-mode="Shell" data-theme="default" id="wiz_cm_1566977747964_3344" class="wiz-code-container"><textarea style="display:none;">             LOAD_FAST
             LOAD_CONST
             BINARY_MODULO
             LOAD_CONST
             COMPARE_OP
             POP_JUMP_IF_FALSE
             LOAD_CONST
             RETURN_VALUE
             JUMP_FORWARD</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566977747964_3344"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 224px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_FAST</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_CONST</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BINARY_MODULO</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_CONST</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; COMPARE_OP</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; POP_JUMP_IF_FALSE</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_CONST</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RETURN_VALUE</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JUMP_FORWARD</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="height: 254px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div>可以看到&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">elif</span>&nbsp;语句和&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">n%3==0</span>&nbsp;在同一个 block 中，原因很明显，因为该 block 不需要额外的 jump 出口。</div></li><li>Block4：和 block3 差不多，只不过指令的参数有所不同。</li><li>Block5：映射到最终的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">orElse</span>&nbsp;AST 节点，包含4条指令：<div data-mode="Shell" data-theme="default" id="wiz_cm_1566979368153_5446" class="wiz-code-container"><textarea style="display:none;">             LOAD_GLOBAL
             LOAD_FAST
             CALL_FUNCTION
             RETURN_VALUE</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566979368153_5446"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 104px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_GLOBAL</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOAD_FAST</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CALL_FUNCTION</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RETURN_VALUE</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 104px;"></div><div class="CodeMirror-gutters" style="height: 134px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">LOAD_GLOBAL</span>&nbsp;接受一个&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">str</span>&nbsp;参数，将&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">str</span>&nbsp;函数加载到栈上。<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">LOAD_FAST</span>&nbsp;将参数&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">n</span>&nbsp;加载到栈上。RETURN_VALUE 将把栈上调用&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">CALL_FUNCTION</span>&nbsp;后得到的值返回。</div></li></ol></div><div style="text-align:left"><hr></div><h5>1.3.6.a 译注：不同<span>&nbsp;python&nbsp;</span>版本 bytecode 上存在的差异</h5><div>经译者在 Python3.5 解释器上进行的测试，与上面的描述存在一些不同：</div><div data-mode="Python" data-theme="default" id="wiz_cm_1566980168226_7543" class="wiz-code-container"><textarea style="display:none;">&gt;&gt;&gt; dis.dis(fizzbuzz)
  2           0 LOAD_FAST                0 (n)
              2 LOAD_CONST               1 (3)
              4 BINARY_MODULO
              6 LOAD_CONST               2 (0)
              8 COMPARE_OP               2 (==)
             10 POP_JUMP_IF_FALSE       28
             12 LOAD_FAST                0 (n)
             14 LOAD_CONST               3 (5)
             16 BINARY_MODULO
             18 LOAD_CONST               2 (0)
             20 COMPARE_OP               2 (==)
             22 POP_JUMP_IF_FALSE       28

  3          24 LOAD_CONST               4 ('FizzBuzz')
             26 RETURN_VALUE

  4     &gt;&gt;   28 LOAD_FAST                0 (n)
             30 LOAD_CONST               1 (3)
             32 BINARY_MODULO
             34 LOAD_CONST               2 (0)
             36 COMPARE_OP               2 (==)
             38 POP_JUMP_IF_FALSE       44

  5          40 LOAD_CONST               5 ('Fizz')
             42 RETURN_VALUE

  6     &gt;&gt;   44 LOAD_FAST                0 (n)
             46 LOAD_CONST               3 (5)
             48 BINARY_MODULO
             50 LOAD_CONST               2 (0)
             52 COMPARE_OP               2 (==)
             54 POP_JUMP_IF_FALSE       60

  7          56 LOAD_CONST               6 ('Buzz')
             58 RETURN_VALUE

  9     &gt;&gt;   60 LOAD_GLOBAL              0 (str)
             62 LOAD_FAST                0 (n)
             64 CALL_FUNCTION            1
             66 RETURN_VALUE
             68 LOAD_CONST               0 (None)
             70 RETURN_VALUE</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566980168226_7543"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 1040px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>43</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>43</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">dis</span>.<span class="cm-property">dis</span>(<span class="cm-variable">fizzbuzz</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-number">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">0</span> <span class="cm-variable">LOAD_FAST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> (<span class="cm-variable">n</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">2</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">1</span> (<span class="cm-number">3</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">4</span> <span class="cm-variable">BINARY_MODULO</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">6</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">2</span> (<span class="cm-number">0</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number cm-error">8</span> <span class="cm-variable">COMPARE_OP</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">2</span> (<span class="cm-operator">==</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">10</span> <span class="cm-variable">POP_JUMP_IF_FALSE</span> &nbsp; &nbsp; &nbsp; <span class="cm-number">28</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number cm-error">12</span> <span class="cm-variable">LOAD_FAST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> (<span class="cm-variable">n</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">14</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">3</span> (<span class="cm-number">5</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number cm-error">16</span> <span class="cm-variable">BINARY_MODULO</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">18</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">2</span> (<span class="cm-number">0</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number cm-error">20</span> <span class="cm-variable">COMPARE_OP</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">2</span> (<span class="cm-operator">==</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">22</span> <span class="cm-variable">POP_JUMP_IF_FALSE</span> &nbsp; &nbsp; &nbsp; <span class="cm-number">28</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-number cm-error">3</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">24</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">4</span> (<span class="cm-string">'FizzBuzz'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">26</span> <span class="cm-variable">RETURN_VALUE</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-number cm-error">4</span> &nbsp; &nbsp; <span class="cm-operator">&gt;&gt;</span> &nbsp; <span class="cm-number">28</span> <span class="cm-variable">LOAD_FAST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> (<span class="cm-variable">n</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">30</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">1</span> (<span class="cm-number">3</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">20</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">32</span> <span class="cm-variable">BINARY_MODULO</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">21</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">34</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">2</span> (<span class="cm-number">0</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">22</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">36</span> <span class="cm-variable">COMPARE_OP</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">2</span> (<span class="cm-operator">==</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">23</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number cm-error">38</span> <span class="cm-variable">POP_JUMP_IF_FALSE</span> &nbsp; &nbsp; &nbsp; <span class="cm-number">44</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">24</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">25</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-number cm-error">5</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">40</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">5</span> (<span class="cm-string">'Fizz'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">26</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">42</span> <span class="cm-variable">RETURN_VALUE</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">27</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">28</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-number cm-error">6</span> &nbsp; &nbsp; <span class="cm-operator">&gt;&gt;</span> &nbsp; <span class="cm-number">44</span> <span class="cm-variable">LOAD_FAST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> (<span class="cm-variable">n</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">29</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">46</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">3</span> (<span class="cm-number">5</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">30</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">48</span> <span class="cm-variable">BINARY_MODULO</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">31</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">50</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">2</span> (<span class="cm-number">0</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">32</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">52</span> <span class="cm-variable">COMPARE_OP</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">2</span> (<span class="cm-operator">==</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">33</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number cm-error">54</span> <span class="cm-variable">POP_JUMP_IF_FALSE</span> &nbsp; &nbsp; &nbsp; <span class="cm-number">60</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">34</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">35</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-number cm-error">7</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">56</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">6</span> (<span class="cm-string">'Buzz'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">36</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">58</span> <span class="cm-variable">RETURN_VALUE</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">37</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">38</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp;<span class="cm-number cm-error">9</span> &nbsp; &nbsp; <span class="cm-operator">&gt;&gt;</span> &nbsp; <span class="cm-number">60</span> <span class="cm-variable">LOAD_GLOBAL</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> (<span class="cm-builtin">str</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">39</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">62</span> <span class="cm-variable">LOAD_FAST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> (<span class="cm-variable">n</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">40</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">64</span> <span class="cm-variable">CALL_FUNCTION</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">41</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">66</span> <span class="cm-variable">RETURN_VALUE</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">42</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">68</span> <span class="cm-variable">LOAD_CONST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">0</span> (<span class="cm-keyword">None</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">43</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number cm-error">70</span> <span class="cm-variable">RETURN_VALUE</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 1040px;"></div><div class="CodeMirror-gutters" style="height: 1070px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">从上面的代码清单可以看出，并不像书中所描述的那样，<span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">fizzbuzz</span> 函数编译后，<span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">elif</span> 分支也像 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">if</span> 分支那样 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">BoolOp</span> 与后面的子句存在于两个不同的 code block 当中。</div><div><hr></div><div style="text-align:left">和前面的章节一样，我们来看一下具体的数据结构。</div><h5>1.3.6.1 编译器数据结构</h5><div style="text-align:left">下图展示了组成CFG基础块生成过程中所涉及到的主要数据结构之间的关系：</div><div style="text-align:left"><img alt="Figure 3.4: The four major data structures used in generating a code object." src="Inside The Python Virtual Machine（前三章翻译）_files/8f23e180-6dd4-459f-af83-9ed883579458.png"><br></div><blockquote><div style="text-align:left"><span data-wiz-span="data-wiz-span" style="color: rgb(153, 153, 153);">图1.3.6.1 生成 code object 过程中 4 个主要的数据结构。</span></div></blockquote><div style="text-align:left">在顶层是一个&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">compiler</span>&nbsp;数据结构，它捕获了模块的全局编译过程，这个结构体定义在 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/compile.c#L151">Python/compile.c</a></span> 文件中。</div><div data-mode="C" data-theme="default" id="wiz_cm_1566981215522_5141" class="wiz-code-container"><textarea style="display:none;">struct compiler {
    PyObject *c_filename;
    struct symtable *c_st;
    PyFutureFeatures *c_future; /* pointer to module's __future__ */
    PyCompilerFlags *c_flags;

    int c_optimize;              /* optimization level */
    int c_interactive;           /* true if in interactive mode */
    int c_nestlevel;

    struct compiler_unit *u; /* compiler state for current block */
    PyObject *c_stack;           /* Python list holding compiler_unit ptrs */
    PyArena *c_arena;            /* pointer to memory allocation arena */
};</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566981215522_5141"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 344px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>14</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>14</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">compiler</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">c_filename</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">symtable</span> <span class="cm-operator">*</span><span class="cm-variable">c_st</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyFutureFeatures</span> <span class="cm-operator">*</span><span class="cm-variable">c_future</span>; <span class="cm-comment">/* pointer to module's __future__ */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyCompilerFlags</span> <span class="cm-operator">*</span><span class="cm-variable">c_flags</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">c_optimize</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* optimization level */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">c_interactive</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">/* true if in interactive mode */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">c_nestlevel</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">compiler_unit</span> <span class="cm-operator">*</span><span class="cm-variable">u</span>; <span class="cm-comment">/* compiler state for current block */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">c_stack</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">/* Python list holding compiler_unit ptrs */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyArena</span> <span class="cm-operator">*</span><span class="cm-variable">c_arena</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* pointer to memory allocation arena */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 344px;"></div><div class="CodeMirror-gutters" style="height: 374px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">我们对其中几个字段比较感兴趣：</div><div style="text-align: left;"><ol class="wiz-list-level1"><li><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">*c_st</span>：指向之前生成的符号表。</li><li><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">*u</span>：一个到 compiler unit 结构体的引用。这个结构体封装了与一个 code block 进行交互所需的信息。本字段指向目前正在处理的 code block 所对应的 compiler unit。</li><li><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">*c_stack</span>：一个到&nbsp;<span>compiler unit</span>&nbsp;栈的引用。当一个 code block 由多个 code block 所组成时，这个字段负责当遇到一个新的 block 时&nbsp;<span>compiler unit</span>&nbsp;结构体的储存与恢复。当进入一个新的 code block 时，一个新的作用域被创建，然后&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/compile.c#L522">compiler_enter_scope()</a></span>&nbsp;会将当前的 compiler unit&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><span>&nbsp;</span>*u</span>&nbsp;push 到栈中。同时&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">*c_stack</span>&nbsp;创建一个新的 compiler unit 对象并将其设置为当前compiler unit。当离开一个 block 的时候，<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">*c_stack</span>&nbsp;会根据复原状态进行弹出。</li></ol></div><div style="text-align:left">对于每个被编译的模块，对应一个被初始化的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">compiler</span>&nbsp;数据结构。当 AST 被遍历，其中每一个 code block 对应的&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">compiler_unit</span>&nbsp;数据结构会被生成。</div><h5>1.3.6.2 compiler_unit 数据结构</h5><div><span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.08rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/compile.c#L103">compiler_unit</a></span>&nbsp;结构体的定义展示在下面的代码清单中，它持有生成一个 code block 对应的字节码指令所需的信息。当查看这个结构体的定义时会发现，很多字段的名字你可能会比较熟悉。</div><div data-mode="C" data-theme="default" id="wiz_cm_1566983205832_8951" class="wiz-code-container"><textarea style="display:none;">struct compiler_unit {
    PySTEntryObject *u_ste;

    PyObject *u_name;
    PyObject *u_qualname;  /* dot-separated qualified name (lazy) */
    int u_scope_type;

    /* The following fields are dicts that map objects to
       the index of them in co_XXX.      The index is used as
       the argument for opcodes that refer to those collections.
    */
    PyObject *u_consts;    /* all constants */
    PyObject *u_names;     /* all names */
    PyObject *u_varnames;  /* local variables */
    PyObject *u_cellvars;  /* cell variables */
    PyObject *u_freevars;  /* free variables */

    PyObject *u_private;        /* for private name mangling */

    Py_ssize_t u_argcount;        /* number of arguments for block */
    Py_ssize_t u_kwonlyargcount; /* number of keyword only arguments for block */
    /* Pointer to the most recently allocated block.  By following b_list
       members, you can reach all early allocated blocks. */
    basicblock *u_blocks;
    basicblock *u_curblock; /* pointer to current block */

    int u_nfblocks;
    struct fblockinfo u_fblock[CO_MAXBLOCKS];

    int u_firstlineno; /* the first lineno of the block */
    int u_lineno;          /* the lineno for the current stmt */
    int u_col_offset;      /* the offset of the current stmt */
    int u_lineno_set;  /* boolean to indicate whether instr
                          has been generated with current lineno */
};</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566983205832_8951"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 870px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>35</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>35</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">compiler_unit</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PySTEntryObject</span> <span class="cm-operator">*</span><span class="cm-variable">u_ste</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">u_name</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">u_qualname</span>; &nbsp;<span class="cm-comment">/* dot-separated qualified name (lazy) */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-type">u_scope_type</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* The following fields are dicts that map objects to</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-comment">the index of them in co_XXX. &nbsp; &nbsp;  The index is used as</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-comment">the argument for opcodes that refer to those collections.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">u_consts</span>; &nbsp; &nbsp;<span class="cm-comment">/* all constants */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">u_names</span>; &nbsp; &nbsp; <span class="cm-comment">/* all names */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">u_varnames</span>; &nbsp;<span class="cm-comment">/* local variables */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">u_cellvars</span>; &nbsp;<span class="cm-comment">/* cell variables */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">u_freevars</span>; &nbsp;<span class="cm-comment">/* free variables */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PyObject</span> <span class="cm-operator">*</span><span class="cm-variable">u_private</span>; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* for private name mangling */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">20</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">Py_ssize_t</span> <span class="cm-variable">u_argcount</span>; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* number of arguments for block */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">21</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">Py_ssize_t</span> <span class="cm-variable">u_kwonlyargcount</span>; <span class="cm-comment">/* number of keyword only arguments for block */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">22</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* Pointer to the most recently allocated block.  By following b_list</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">23</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-comment">members, you can reach all early allocated blocks. */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">24</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">basicblock</span> <span class="cm-operator">*</span><span class="cm-variable">u_blocks</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">25</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">basicblock</span> <span class="cm-operator">*</span><span class="cm-variable">u_curblock</span>; <span class="cm-comment">/* pointer to current block */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">26</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">27</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">u_nfblocks</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">28</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">fblockinfo</span> <span class="cm-def">u_fblock</span>[<span class="cm-variable">CO_MAXBLOCKS</span>];</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">29</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span></span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">30</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">u_firstlineno</span>; <span class="cm-comment">/* the first lineno of the block */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">31</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">u_lineno</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* the lineno for the current stmt */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">32</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">u_col_offset</span>; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* the offset of the current stmt */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">33</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">u_lineno_set</span>; &nbsp;<span class="cm-comment">/* boolean to indicate whether instr</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">34</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">has been generated with current lineno */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">35</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 870px;"></div><div class="CodeMirror-gutters" style="height: 900px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">字段&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.08rem; background-color: rgb(239, 239, 239);">u_blocks</span>&nbsp;与&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.08rem; background-color: rgb(239, 239, 239);">u_curblock</span>&nbsp;用于引用那些组成被编译的 code block 的基础块。<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.08rem; background-color: rgb(239, 239, 239);">*u_ste</span>&nbsp;字段为到一个被编译的 code block 中的符号表项的引用。其余的字段从它们的名字上就比较容易理解。组成 code block 的不同节点在编译过程中会被遍历，并且根据一个节点类型是否能够起始一个 basic block，一个含有 node 对应指令的 basic block 会被创建，或者有新指令被添加到已有的 basic block 当中。能够起始一个 basic block 的节点类型包括但不限于：</div><div style="text-align: left;"><ol class="wiz-list-level1"><li>函数节点</li><li>跳转目标</li><li>异常处理</li><li>布尔运算等</li></ol></div><h5>1.3.6.3 basic block 与 instruction 数据结构</h5><div><a href="https://github.com/python/cpython/blob/3.5/Python/compile.c#L53">basicblock_</a> 结构体是一种在 CFG 生成过程中相当有趣的数据结构。一个 basic block 是一个具有单一入口与多个出口的指令序列。在 CPython 中它的定义如下：</div><div data-mode="C" data-theme="default" id="wiz_cm_1566990288318_6865" class="wiz-code-container"><textarea style="display:none;">typedef struct basicblock_ {
    /* Each basicblock in a compilation unit is linked via b_list in the
       reverse order that the block are allocated.  b_list points to the next
       block, not to be confused with b_next, which is next by control flow. */
    struct basicblock_ *b_list;
    /* number of instructions used */
    int b_iused;
    /* length of instruction array (b_instr) */
    int b_ialloc;
    /* pointer to an array of instructions, initially NULL */
    struct instr *b_instr;
    /* If b_next is non-NULL, it is a pointer to the next
       block reached by normal control flow. */
    struct basicblock_ *b_next;
    /* b_seen is used to perform a DFS of basicblocks. */
    unsigned b_seen : 1;
    /* b_return is true if a RETURN_VALUE opcode is inserted. */
    unsigned b_return : 1;
    /* depth of stack upon entry of block, computed by stackdepth() */
    int b_startdepth;
    /* instruction offset for block, computed by assemble_jump_offsets() */
    int b_offset;
} basicblock;</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566990288318_6865"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 560px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors" style="visibility: hidden;"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-def">basicblock_</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* Each basicblock in a compilation unit is linked via b_list in the</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-comment">reverse order that the block are allocated.  b_list points to the next</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-comment">block, not to be confused with b_next, which is next by control flow. */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">basicblock_</span> <span class="cm-operator">*</span><span class="cm-variable">b_list</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* number of instructions used */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">b_iused</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* length of instruction array (b_instr) */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">b_ialloc</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* pointer to an array of instructions, initially NULL */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">instr</span> <span class="cm-operator">*</span><span class="cm-variable">b_instr</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* If b_next is non-NULL, it is a pointer to the next</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-comment">block reached by normal control flow. */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">basicblock_</span> <span class="cm-operator">*</span><span class="cm-variable">b_next</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* b_seen is used to perform a DFS of basicblocks. */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">b_seen</span> : <span class="cm-number">1</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* b_return is true if a RETURN_VALUE opcode is inserted. */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">b_return</span> : <span class="cm-number">1</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* depth of stack upon entry of block, computed by stackdepth() */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">20</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">b_startdepth</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">21</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* instruction offset for block, computed by assemble_jump_offsets() */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">22</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">b_offset</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">23</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">} <span class="cm-variable">basicblock</span>;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 560px;"></div><div class="CodeMirror-gutters" style="height: 590px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">正如之前所说的，CFG 由一系列 basic blocks 以及它们之间的连接所组成。<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">*b_instr</span>&nbsp;字段引用到一个指令结构体的数组，一个指令结构体对应于一条字节码指令，字节码指令的编号可在头文件&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/ce6a070414/Include/opcode.h">Include/opcode.h</a></span>&nbsp;中找到。指令结构体 instr 定义在文件 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/compile.c#L43">Python/compile.c</a></span> 中。</div><div data-mode="C" data-theme="default" id="wiz_cm_1566990577007_7213" class="wiz-code-container"><textarea style="display:none;">struct instr {
    unsigned i_jabs : 1;   // 绝对跳转 jump absolute
    unsigned i_jrel : 1;   // 相对跳转 jump relative
    unsigned i_hasarg : 1;
    unsigned char i_opcode;
    int i_oparg;
    struct basicblock_ *i_target; /* target block (if jump instruction) */
    int i_lineno;
};</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1566990577007_7213"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 224px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">instr</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">i_jabs</span> : <span class="cm-number">1</span>; &nbsp; <span class="cm-comment">// 绝对跳转 jump absolute</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">i_jrel</span> : <span class="cm-number">1</span>; &nbsp; <span class="cm-comment">// 相对跳转 jump relative</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-variable">i_hasarg</span> : <span class="cm-number">1</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">unsigned</span> <span class="cm-type">char</span> <span class="cm-variable">i_opcode</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">i_oparg</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">basicblock_</span> <span class="cm-operator">*</span><span class="cm-type">i_target</span>; <span class="cm-comment">/* target block (if jump instruction) */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">i_lineno</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="height: 254px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">再回头看一下图1.3.6.b，我们可以看到由 block1 到 block2 存在两条可行的路径。第一条路径是正常执行由 block1 到 block2，第二条是在第一次比较时直接跳转到 block2 。目前这个跳转的目标时一个 basic block 但是 code object 在实际执行的时候对 basic block 并不知情。code object 中只有字节码流（bytecodes stream）并且我们只能通过偏移量对它进行索引。我们必须将使用 block 创建的隐式图作为跳转目标，并以某种方式将这些具有偏移的 block 替换为指令数组。这就是 basic blocks 的汇编（assembling）过程。</div><h4>1.3.7 汇编 basic blocks</h4><div style="text-align: left;">一旦 CFG 被生成，basic blocks 包含了字节码指令，但目前这些 blocks 还不是线性排列的。跳转指令的目标仍是 basic block 而不是指令流中的绝对偏移量。<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/compile.c#L4687">assemble</a></span>&nbsp;函数将会把 CFG 进行线性排列并生成 code object。</div><div style="text-align: left;">首先，<span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">assemble</span> 函数会任何没有 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">return</span> 语句的 block 的结尾添加一个 <span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">return None</span><span data-wiz-span="data-wiz-span">&nbsp;，现在你知道为什么可以在函数和方法中不写 </span><span data-wiz-span="data-wiz-span" style="font-size:1.013rem;font-family:&quot;Lucida Console&quot;, monospace;background-color:rgb(239, 239, 239)">return</span><span data-wiz-span="data-wiz-span"> 了吧。然后会以后序深度优先（post-order deep first）的方式遍历 CFG 图，以对它进行扁平化。后序遍历指的是在遍历时先访问所有的子节点再<span>访问</span>根节点。</span></div><hr><h5>图遍历：</h5><div style="text-align: left;"><img src="https://leanpub.com/site_images/insidethepythonvirtualmachine/dfs.png" alt="Figure 3.5 : Depth first transversal of a graph start from root node A and moving to the left."><br></div><div style="text-align: left;">在对一个图进行后序深度优先遍历时，我们首先会递归地访问一个根结点的左子节点，然后是右子节点，然后才是这个根节点自己。比如以上面这个图结构作为例子，当我们以后序深度优先遍历对它进行扁平化的时候，对节点的访问顺序是：<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">H -&gt; D -&gt; I -&gt; J -&gt; E -&gt; B -&gt; K -&gt; L -&gt; F -&gt; G -&gt; C -&gt; A</span>&nbsp;。如果是前序（pre-order）遍历的话：<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">A -&gt; B -&gt; D -&gt; H -&gt; E -&gt; I -&gt; J -&gt; C -&gt; F -&gt; K -&gt; L -&gt; G</span>&nbsp;。而如果是中序（in-order）遍历：<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">H -&gt; D -&gt; B -&gt; I -&gt; E -&gt; J -&gt; A -&gt; K -&gt; L -&gt; F -&gt; C -&gt; G</span>&nbsp;。</div><hr><div style="text-align: left;"><span data-wiz-span="data-wiz-span" style="font-size: 1.013rem; font-family: &quot;Lucida Console&quot;, monospace; background-color: rgb(239, 239, 239);">fizzbuzz</span> 函数的 CFG （图1.3.6.b）相对比较简单，如果对它进行后序遍历，顺序是：<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);">block5 -&gt; block4 -&gt; block3 -&gt; block2 -&gt; block1</span>&nbsp;。当 CFG 被扁平化（或者说是线性化）以后，扁平化图的跳转指令的跳转偏移量就可以被&nbsp;<span style="font-family: &quot;Lucida Console&quot;, monospace; font-size: 1.013rem; background-color: rgb(239, 239, 239);"><a href="https://github.com/python/cpython/blob/3.5/Python/compile.c#L4462">assemble_jump_offsets</a></span> 函数计算出来了。</div><div style="text-align: left;">对跳转偏移量的汇编需要两个阶段，在第一个阶段，每条指令的偏移量会被计算出来放进指令数组中，就像下面的代码清单中所展示的那样。这是一个简单的循环，它从被 CFG 扁平化后得到的数组的末尾开始从 0 开始生成每一个 block 对应的偏移量。</div><div data-mode="C" data-theme="default" id="wiz_cm_1567063794250_4359" class="wiz-code-container"><textarea style="display:none;">		...        
		totsize = 0;
        for (i = a-&gt;a_nblocks - 1; i &gt;= 0; i--) {
            b = a-&gt;a_postorder[i];
            bsize = blocksize(b);
            b-&gt;b_offset = totsize;
            totsize += bsize;
        }
		...</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1567063794250_4359"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 224px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span>... &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">totsize</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">a</span><span class="cm-operator">-&gt;</span><span class="cm-variable">a_nblocks</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span><span class="cm-operator">--</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-variable">a</span><span class="cm-operator">-&gt;</span><span class="cm-variable">a_postorder</span>[<span class="cm-variable">i</span>];</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">bsize</span> <span class="cm-operator">=</span> <span class="cm-variable">blocksize</span>(<span class="cm-variable">b</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">b</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_offset</span> <span class="cm-operator">=</span> <span class="cm-variable">totsize</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">totsize</span> <span class="cm-operator">+=</span> <span class="cm-variable">bsize</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span>...</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="height: 254px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">在第二阶段，跳转指令的跳转目标偏移量被计算出来，这一步涉及到计算绝对跳转与相对跳转的跳转地址：</div><div data-mode="C" data-theme="default" id="wiz_cm_1567064214382_4814" class="wiz-code-container"><textarea style="display:none;">		...
		for (b = c-&gt;u-&gt;u_blocks; b != NULL; b = b-&gt;b_list) {
            bsize = b-&gt;b_offset;
            for (i = 0; i &lt; b-&gt;b_iused; i++) {
                struct instr *instr = &amp;b-&gt;b_instr[i];
                /* Relative jumps are computed relative to
                   the instruction pointer after fetching
                   the jump instruction.
                */
                bsize += instrsize(instr);
                if (instr-&gt;i_jabs)  // 绝对跳转
                    instr-&gt;i_oparg = instr-&gt;i_target-&gt;b_offset;
                else if (instr-&gt;i_jrel) {  // 相对跳转
                    int delta = instr-&gt;i_target-&gt;b_offset - bsize;
                    instr-&gt;i_oparg = delta;
                }
                else
                    continue;
                if (instr-&gt;i_oparg &gt; 0xffff)
                    extended_arg_count++;
            }
        }
		...</textarea><wiz_code_mirror><div class="CodeMirror cm-s-default CodeMirror-wrap" data-id="wiz_cm_1567064214382_4814"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 20px; left: 34px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:0px; width:1000px; height:1em;" tabindex="0"></textarea></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll"><div class="CodeMirror-sizer" style="margin-left: 30px; margin-bottom: 0px; border-right-width: 30px; min-height: 560px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="wiz-hide wiz_CodeMirror-cursors"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 24px;">&nbsp;</div></div><div class="CodeMirror-code"><div style="position: relative;" class="CodeMirror-activeline"><div class="wiz-hide wiz_CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -30px; width: 30px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">1</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span>...</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">for</span> (<span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span><span class="cm-operator">-&gt;</span><span class="cm-variable">u</span><span class="cm-operator">-&gt;</span><span class="cm-variable">u_blocks</span>; <span class="cm-variable">b</span> <span class="cm-operator">!=</span> <span class="cm-atom">NULL</span>; <span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-variable">b</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_list</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">bsize</span> <span class="cm-operator">=</span> <span class="cm-variable">b</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_offset</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">b</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_iused</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">instr</span> <span class="cm-operator">*</span><span class="cm-variable">instr</span> <span class="cm-operator">=</span> <span class="cm-operator">&amp;</span><span class="cm-variable">b</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_instr</span>[<span class="cm-variable">i</span>];</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* Relative jumps are computed relative to</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">the instruction pointer after fetching</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">8</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">the jump instruction.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">9</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">10</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">bsize</span> <span class="cm-operator">+=</span> <span class="cm-variable">instrsize</span>(<span class="cm-variable">instr</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">11</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">instr</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_jabs</span>) &nbsp;<span class="cm-comment">// 绝对跳转</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">12</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">instr</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_oparg</span> <span class="cm-operator">=</span> <span class="cm-variable">instr</span><span class="cm-operator">-&gt;</span><span class="cm-type">i_target</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_offset</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">13</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">instr</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_jrel</span>) { &nbsp;<span class="cm-comment">// 相对跳转</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">14</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-type">int</span> <span class="cm-variable">delta</span> <span class="cm-operator">=</span> <span class="cm-variable">instr</span><span class="cm-operator">-&gt;</span><span class="cm-type">i_target</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_offset</span> <span class="cm-operator">-</span> <span class="cm-variable">bsize</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">15</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">instr</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_oparg</span> <span class="cm-operator">=</span> <span class="cm-variable">delta</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">16</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">17</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">18</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">19</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">instr</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_oparg</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0xffff</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">20</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">extended_arg_count</span><span class="cm-operator">++</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">21</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">22</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -30px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">23</div></div><pre class="CodeMirror-line"><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span>...</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; border-bottom: 0px solid transparent; top: 560px;"></div><div class="CodeMirror-gutters" style="height: 590px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></wiz_code_mirror></div><div style="text-align: left;">随着跳转地址被计算，扁平化后的 CFG 内的指令以<span>反向后序顺序（reverse post order）被</span>生成。反向后序顺序是对 CFG 的拓扑排序，也就是说对于 CFG 中所有的边 (u, v)，在这个排序中 u 都会排在 v 前面。这样做的原因很明显，我们一般来说想要把跳转的起点放在终点之前。当字节码生成完毕，code object 对象就可以根据这些字节码以及符号表中的信息进行生成，code object 对象返回给调用函数的时候，整个编译过程就在此结束了。</div><div style="text-align: left;"><br></div><div style="text-align: left;"><span style="font-size: 1.5rem; font-weight: bold;">其它资料：</span><br></div><div><ul><li>一篇关于Py程序执行过程的博文：&nbsp;<a href="https://tech.blog.aknin.name/2010/04/02/pythons-innards-introduction/">Python’s Innards: Introduction</a>,&nbsp;Yaniv Aknin</li><li>Pycon 2012 video: <a href="https://www.youtube.com/watch?v=XGF3Qu4dUqk">Stepping Through CPython</a>,&nbsp;Larry Hastings</li><li><a href="https://paper.dropbox.com/doc/Yet-another-guided-tour-of-CPython-XY7KgFGn88zMNivGJ4Jzv#:h2=Yet-another-guided-tour-of-CPy">Yet another guided tour of CPython</a>, Guido Van</li><li>关于PEP554：<a href="https://hackernoon.com/has-the-python-gil-been-slain-9440d28fa93d?gi=dc943cdbca57">Has the Python GIL been slain</a>, Anthony Shaw</li><li><a href="http://aosabook.org/en/500L/a-python-interpreter-written-in-python.html">A Python Interpreter Written in Python</a>, Allison Kaptur</li></ul></div><div><br></div><div>后续内容的翻译将放在 <a href="https://nanguage.gitbook.io/inside-python-vm-cn/">GitBook</a> 上并且使用 Python3.7 作为例子，欢迎贡献。</div><div><br></div></body></html>